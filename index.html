<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>RentPoa - Property Management</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--black:#0b0b0b;--red:#c0392b;--green:#27ae60;--blue:#3498db;--orange:#f39c12;--purple:#9b59b6;}
*{box-sizing:border-box}
body,html{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999;}
.loading-overlay.show{display:flex;}
.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}
#loginScreen, #signupScreen{height:100vh;background:url("https://images.unsplash.com/photo-1568605114967-8130f3a36994?auto=format&fit=crop&w=1600&q=80") center/cover no-repeat;display:flex;align-items:center;justify-content:center}
#signupScreen{display:none}
.authCard{width:500px;background:rgba(0,0,0,0.85);padding:32px;border-radius:12px;color:#fff;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.authCard h2{margin:0 0 20px;font-size:24px}
.authCard input{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#fff;font-size:14px}
.authCard input::placeholder{color:rgba(255,255,255,0.7)}
.authCard input:focus{outline:none;border-color:var(--blue);background:rgba(255,255,255,0.15)}
.btn{background:var(--blue);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;margin:8px 4px;transition:all 0.3s ease;font-size:14px}
.btn:hover{background:#2980b9}
.btn.red{background:var(--red)}
.btn.red:hover{background:#a93226}
.btn.green{background:var(--green)}
.btn.green:hover{background:#229954}
.btn.orange{background:var(--orange)}
.btn.orange:hover{background:#d68910}
.error, .success{padding:12px;border-radius:8px;margin:12px 0;font-weight:600;display:none}
.error{background:rgba(192,57,43,0.9);color:#fff}
.success{background:rgba(39,174,96,0.9);color:#fff}
#app{display:none;height:100vh;overflow:hidden}
.header{background:var(--black);color:#fff;padding:0;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.logo{font-weight:700;font-size:20px;padding:15px 20px}
.hamburger{display:none;flex-direction:column;justify-content:space-around;width:24px;height:20px;background:transparent;border:none;cursor:pointer;padding:0;margin-left:15px}
.hamburger span{display:block;height:3px;width:100%;background:#fff;border-radius:2px;transition:all 0.3s ease}
.hamburger.open span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}
.hamburger.open span:nth-child(2){opacity:0}
.hamburger.open span:nth-child(3){transform:rotate(-45deg) translate(7px,-6px)}
.header-left{display:flex;align-items:center}
.user-info{display:flex;align-items:center;gap:15px;padding:15px 20px}
.logout-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 12px;border-radius:4px;cursor:pointer;transition:all 0.3s ease;font-size:12px}
.logout-btn:hover{background:rgba(255,255,255,0.1)}
.trial-banner{background:linear-gradient(135deg, var(--orange), var(--red));color:#fff;padding:10px 20px;text-align:center;font-weight:600;box-shadow:0 2px 5px rgba(0,0,0,0.2);animation:pulse 2s infinite;}
@keyframes pulse{0%, 100%{opacity:1} 50%{opacity:0.8}}
.subscription-badge{background:var(--green);color:#fff;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;}
.subscription-badge.trial{background:var(--orange);}
.subscription-badge.owner{background:linear-gradient(135deg, #9b59b6, #8e44ad);color:#fff;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;box-shadow:0 2px 8px rgba(155, 89, 182, 0.4);}
.subscription-badge.expired{background:var(--red);}
.content{display:flex;height:calc(100vh - 60px)}
.sidebar{width:250px;background:linear-gradient(180deg,#2c3e50 0%,#34495e 100%);overflow-y:auto}
.nav-item{padding:15px 20px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);transition:background 0.3s ease;color:rgba(255,255,255,0.8);font-weight:500}
.nav-item:hover{background:rgba(255,255,255,0.1);color:#fff}
.nav-item.active{background:var(--blue);color:#fff;border-left:4px solid #fff}
#mainSection{flex:1;padding:25px;overflow-y:auto;background:#fff}
.page{display:none}
.page.active{display:block}
.section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #dee2e6}
.section-title h2{margin:0;color:var(--black);font-weight:600}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden;margin-bottom:25px}
th{background:var(--black);color:#fff;padding:15px;text-align:left;font-weight:600;font-size:14px}
td{padding:15px;border-bottom:1px solid #dee2e6;font-size:14px}
tr:hover{background:#f8f9fa}
.actions{display:flex;gap:8px}
.edit, .del, .view{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.3s ease}
.edit{background:var(--blue);color:#fff}
.edit:hover{background:#2980b9}
.del{background:var(--red);color:#fff}
.del:hover{background:#a93226}
.view{background:var(--green);color:#fff}
.view:hover{background:#229954}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:#fff;padding:25px;border-radius:12px;box-shadow:0 2px 15px rgba(0,0,0,0.1);border-left:4px solid var(--blue);transition:transform 0.3s ease}
.stat-card:hover{transform:translateY(-2px)}
.stat-value{font-size:32px;font-weight:700;color:var(--black);margin-bottom:5px}
.stat-label{color:#666;font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:1px}
.status-badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;text-transform:uppercase;}
.status-pending{background:#ffeaa7;color:#e17055;}
.status-paid{background:#55efc4;color:#00b894;}
.status-overdue{background:#fab1a0;color:#e74c3c;}
.payment-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;overflow-y:auto;}
.payment-modal.show{display:flex;}
.payment-content{background:#fff;padding:30px;border-radius:16px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideIn 0.3s ease;margin:20px;}
@keyframes slideIn{from{transform:translateY(-50px);opacity:0} to{transform:translateY(0);opacity:1}}
.payment-header{text-align:center;margin-bottom:30px;}
.payment-header h2{margin:0 0 10px;color:var(--black);font-size:28px;}
.payment-header p{margin:0;color:#666;}
.payment-options{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;}
.payment-option{border:3px solid #dee2e6;border-radius:12px;padding:25px;text-align:center;cursor:pointer;transition:all 0.3s ease;}
.payment-option:hover{border-color:var(--blue);transform:translateY(-2px);}
.payment-option.selected{border-color:var(--green);background:#f0fff4;}
.payment-option .price{font-size:32px;font-weight:700;color:var(--black);margin:10px 0;}
.payment-option .period{color:#666;font-weight:600;text-transform:uppercase;font-size:12px;}
.payment-option .save{background:var(--green);color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;margin-top:8px;display:inline-block;}
.mpesa-instructions{background:#f8f9fa;border-radius:12px;padding:25px;margin-bottom:25px;}
.mpesa-instructions h3{margin:0 0 20px;color:var(--black);display:flex;align-items:center;gap:10px;}
.mpesa-instructions ol{margin:10px 0;padding-left:25px;}
.mpesa-instructions li{margin:10px 0;color:#333;line-height:1.6;}
.mpesa-instructions .highlight{background:var(--green);color:#fff;padding:8px 12px;border-radius:6px;font-weight:700;display:inline-block;margin:5px 0;}
.payment-form{background:#fff;border-radius:8px;margin-top:20px;}
.payment-form input{width:100%;padding:12px;margin:10px 0;border:1px solid #dee2e6;border-radius:8px;font-size:14px;}
.payment-form input:focus{outline:none;border-color:var(--blue);}
.copyright-footer{position:fixed;bottom:0;right:0;background:rgba(0,0,0,0.8);color:#fff;padding:10px 15px;font-size:12px;border-radius:8px 0 0 0;z-index:1000;font-weight:500}
/* Invoice Dropdown Styles */
.invoice-dropdown{position:relative;display:inline-block;}
.invoice-dropdown-content{display:none;position:absolute;background-color:#fff;min-width:200px;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);z-index:1000;border-radius:8px;margin-top:5px;}
.invoice-dropdown:hover .invoice-dropdown-content{display:block;}
.invoice-dropdown-content button{display:block;width:100%;padding:12px 16px;text-align:left;border:none;background:#fff;color:#333;cursor:pointer;font-size:14px;border-bottom:1px solid #eee;transition:background 0.3s ease;}
.invoice-dropdown-content button:hover{background:#f8f9fa;}
.invoice-dropdown-content button:last-child{border-bottom:none;}
/* Invoice Modal Styles */
.invoice-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;align-items:center;justify-content:center;}
.invoice-modal.show{display:flex;}
.invoice-content{background:#fff;padding:40px;border-radius:16px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideIn 0.3s ease;}
@keyframes slideIn{from{transform:translateY(-50px);opacity:0} to{transform:translateY(0);opacity:1}}
.invoice-form{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;}
.invoice-form .full-width{grid-column:1 / -1;}
.invoice-form label{display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#333;}
.invoice-form input,.invoice-form select,.invoice-form textarea{width:100%;padding:12px;border:1px solid #dee2e6;border-radius:8px;font-size:14px;}
.invoice-form input:focus,.invoice-form select:focus,.invoice-form textarea:focus{outline:none;border-color:var(--blue);}
.invoice-total{display:flex;justify-content:space-between;align-items:center;padding:20px;background:#f8f9fa;border-radius:8px;margin:20px 0;}
.invoice-total .total-amount{font-size:24px;font-weight:700;color:var(--green);}
.invoice-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}
@media (max-width:768px){
.hamburger{display:flex}
.content{flex-direction:row}
.sidebar{
width: 280px;
height: calc(100vh - 60px);
position: fixed;
top: 60px;
left: -280px;
z-index: 1000;
overflow-y: auto;
background: linear-gradient(180deg,#2c3e50 0%,#34495e 100%);
transition: left 0.3s ease;
}
.sidebar.open{
left: 0;
}
#mainSection{
flex: 1;
padding: 15px;
overflow-y: auto;
background: #fff;
width: 100%;
}
.stats-grid{grid-template-columns:1fr 1fr}
.payment-options{grid-template-columns:1fr}
.invoice-form{grid-template-columns:1fr}
.nav-item{padding:12px 15px;font-size:14px}
.logo{font-size:18px;padding:12px 15px}
.user-info{padding:12px 15px;gap:10px}
.section-title h2{font-size:20px}
table{font-size:12px}
th, td{padding:10px 8px}
.actions{gap:5px}
.edit, .del, .view{padding:4px 8px;font-size:11px}
}
@media (max-width:480px){
.sidebar{
width: 250px;
left: -250px;
}
.sidebar.open{
left: 0;
}
#mainSection{
padding: 10px;
}
.stats-grid{grid-template-columns:1fr}
.payment-content{
max-width: 95%;
padding: 20px;
margin: 10px;
}
.nav-item{padding:10px 12px;font-size:13px}
.logo{font-size:16px;padding:10px 12px}
}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
<div class="spinner"></div>
</div>
<div id="loginScreen">
<div class="authCard">
<h2>ğŸ  RentPoa Login</h2>
<div id="loginError" class="error"></div>
<div id="loginSuccess" class="success"></div>
<input type="email" id="loginEmail" placeholder="Email" />
<input type="password" id="loginPassword" placeholder="Password" />
<button class="btn" onclick="login()">Sign In</button>
<p style="margin-top:20px;color:rgba(255,255,255,0.7)">
Don't have an account? <a href="#" onclick="showSignup()" style="color:var(--blue)">Sign up</a>
</p>
</div>
</div>
<div id="signupScreen">
<div class="authCard">
<h2>ğŸ  Create Account</h2>
<div id="signupError" class="error"></div>
<div id="signupSuccess" class="success"></div>
<input type="text" id="signupName" placeholder="Full Name" />
<input type="email" id="signupEmail" placeholder="Email" />
<input type="password" id="signupPassword" placeholder="Password (min 6 chars)" />
<p style="font-size:13px;color:rgba(255,255,255,0.8);margin:15px 0;">
âš¡ Start with 1 hour FREE trial<br>
Then Ksh 3,000/month or Ksh 20,000/year
</p>
<button class="btn" onclick="signup()">Create Account & Start Trial</button>
<p style="margin-top:20px;color:rgba(255,255,255,0.7)">
Already have an account? <a href="#" onclick="showLogin()" style="color:var(--blue)">Sign in</a>
</p>
</div>
</div>
<div id="app">
<div class="header">
<div class="header-left">
<button class="hamburger" onclick="toggleMobileMenu()">
<span></span>
<span></span>
<span></span>
</button>
<div class="logo">ğŸ  RentPoa</div>
</div>
<div class="user-info">
<span class="subscription-badge" id="subscriptionBadge">FREE TRIAL</span>
<span id="userName"></span>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>
</div>
<div class="trial-banner" id="trialBanner" style="display:none;">
â° Free Trial: <span id="trialTimer"></span> remaining
</div>
<div class="content">
<div class="sidebar">
<div class="nav-item active" onclick="showSection('dashboard')">ğŸ“Š Dashboard</div>
<div class="nav-item" onclick="showSection('housetypes')">ğŸ  House Types</div>
<div class="nav-item" onclick="showSection('properties')">ğŸ¢ Properties</div>
<div class="nav-item" onclick="showSection('tenants')">ğŸ‘¥ Tenants</div>
<div class="nav-item" onclick="showSection('invoices')">ğŸ“„ Invoices</div>
<div class="nav-item" onclick="showSection('receipts')">ğŸ§¾ Receipts</div>
<div class="nav-item" onclick="showSection('payments')">ğŸ’° Payments</div>
<div class="nav-item" onclick="showSection('expenses')">ğŸ”§ Expenses</div>
<div class="nav-item" onclick="showSection('reports')">ğŸ“Š Reports</div>
</div>
<div id="mainSection">
<div id="dashboard" class="page active">
<div class="section-title">
<h2>Dashboard</h2>
</div>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="totalProperties">0</div>
<div class="stat-label">Total Properties</div>
</div>
<div class="stat-card">
<div class="stat-value" id="totalTenants">0</div>
<div class="stat-label">Total Tenants</div>
</div>
<div class="stat-card">
<div class="stat-value" id="monthlyIncome">Ksh 0</div>
<div class="stat-label">Monthly Income</div>
</div>
<div class="stat-card">
<div class="stat-value" id="pendingInvoices">0</div>
<div class="stat-label">Pending Invoices</div>
</div>
</div>
</div>
<div id="housetypes" class="page">
<div class="section-title">
<h2>House Types</h2>
<button class="btn" onclick="showAddHouseTypeForm()">+ Add House Type</button>
</div>
<div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
<h3 style="margin:0 0 15px;font-size:16px;color:#333;">ğŸ¢ Property Occupancy Overview</h3>
<div style="display:grid;grid-template-columns:1fr auto;gap:15px;align-items:end;">
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Select Property</label>
<select id="propertyOccupancyFilter" onchange="loadPropertyOccupancy()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All Properties</option>
</select>
</div>
<button class="btn orange" onclick="clearOccupancyFilter()" style="padding:10px 20px;">Show All</button>
</div>
<div id="occupancyStats" style="margin-top:15px;"></div>
</div>
<table id="houseTypesTable">
<thead>
<tr>
<th>Type Name</th>
<th>Rent Amount</th>
<th>Description</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="properties" class="page">
<div class="section-title">
<h2>Properties</h2>
<button class="btn" onclick="showAddPropertyForm()">+ Add Property</button>
</div>
<table id="propertiesTable">
<thead>
<tr>
<th>Name</th>
<th>Location</th>
<th>House Type</th>
<th>Total Houses</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="tenants" class="page">
<div class="section-title">
<h2>Tenants</h2>
<div style="display:flex;gap:10px;align-items:center;">
<button class="btn" onclick="showAddTenantForm()">+ Add Tenant</button>
</div>
</div>
<div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
<h3 style="margin:0 0 15px;font-size:16px;color:#333;">ğŸ” Filter Tenants</h3>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:15px;align-items:end;">
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Property</label>
<select id="filterProperty" onchange="filterTenants()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All Properties</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">House Type</label>
<select id="filterHouseType" onchange="filterTenants()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All House Types</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Search Tenant</label>
<input type="text" id="filterTenantName" onkeyup="filterTenants()" placeholder="Search by name..." style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;" />
</div>
<button class="btn orange" onclick="clearTenantFilters()" style="padding:10px 20px;">Clear Filters</button>
</div>
<div id="filterStats" style="margin-top:15px;padding:12px;background:#fff;border-radius:6px;font-size:13px;color:#666;font-weight:600;"></div>
</div>
<table id="tenantsTable">
<thead>
<tr>
<th>Name</th>
<th>Phone</th>
<th>Email</th>
<th>Property</th>
<th>House Type</th>
<th>House Number</th>
<th>Rent</th>
<th>Move-in Date</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="invoices" class="page">
<div class="section-title">
<h2>Invoices</h2>
<div>
<div class="invoice-dropdown">
<button class="btn" style="background:var(--blue);">ğŸ“„ Invoice Options â–¼</button>
<div class="invoice-dropdown-content">
<button onclick="showCreateInvoiceModal()">â• Create New Invoice</button>
<button onclick="generateInvoices()">ğŸ“‹ Generate All Invoices</button>
<button onclick="viewInvoices()">ğŸ‘ï¸ View All Invoices</button>
<button onclick="exportInvoicesData()">ğŸ“¤ Export All Data</button>
</div>
</div>
</div>
</div>
<div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
<h3 style="margin:0 0 15px;font-size:16px;color:#333;">ğŸ“‹ Generate Invoice for Specific Tenant</h3>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:15px;align-items:end;">
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Property</label>
<select id="invoiceFilterProperty" onchange="updateInvoiceHouseTypes()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">Select Property</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">House Type</label>
<select id="invoiceFilterHouseType" onchange="updateInvoiceTenants()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">Select House Type</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Tenant</label>
<select id="invoiceFilterTenant" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">Select Tenant</option>
</select>
</div>
<button class="btn" onclick="generateSingleInvoice()" style="padding:10px 20px;">Generate Invoice</button>
<button class="btn green" onclick="exportSingleInvoicePDF()" style="padding:10px 20px;">Export PDF</button>
</div>
<div id="invoiceFilterInfo" style="margin-top:15px;padding:12px;background:#fff;border-radius:6px;font-size:13px;color:#666;font-weight:600;"></div>
</div>
<div style="background:linear-gradient(135deg,#e3f2fd,#bbdefb);padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid var(--blue);">
<h4 style="margin:0 0 8px;color:#1565c0;font-size:15px;">ğŸ†• Enhanced Invoice Features:</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;font-size:13px;color:#1976d2;">
<div>â€¢ <strong>ğŸ“„ Invoice Options</strong> dropdown for advanced features</div>
<div>â€¢ <strong>â• Create New Invoice</strong> with custom bill entries</div>
<div>â€¢ <strong>ğŸ’§ Water, âš¡ Electricity, ğŸ—‘ï¸ Waste, ğŸ”§ Service fees</strong></div>
<div>â€¢ <strong>ğŸ“§ Email invoices</strong> directly to tenants</div>
<div>â€¢ <strong>ğŸ‘ï¸ PDF preview</strong> before generating</div>
<div>â€¢ <strong>âœ¨ Custom invoices</strong> marked with special indicator</div>
</div>
</div>
<table id="invoicesTable">
<thead>
<tr>
<th>Invoice #</th>
<th>Tenant</th>
<th>House</th>
<th>Amount</th>
<th>Due Date</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="payments" class="page">
<div class="section-title">
<h2>Payments</h2>
<div>
<button class="btn" onclick="showRecordPaymentForm()">+ Record Payment</button>
<button class="btn green" onclick="exportPaymentsData()">Export Data</button>
</div>
</div>
<table id="paymentsTable">
<thead>
<tr>
<th>Date</th>
<th>Tenant</th>
<th>House</th>
<th>Amount</th>
<th>Method</th>
<th>Reference</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="receipts" class="page">
<div class="section-title">
<h2>ğŸ§¾ Receipts</h2>
<div>
<button class="btn green" onclick="exportReceiptsData()">ğŸ“Š Export Receipts</button>
<button class="btn orange" onclick="generateReceiptPDF()">ğŸ§¾ Generate PDF</button>
</div>
</div>
<div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
<h3 style="margin:0 0 15px;font-size:16px;color:#333;">ğŸ” Filter Receipts</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;align-items:end;">
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Filter by Property</label>
<select id="receiptPropertyFilter" onchange="onPropertyFilterChange()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All Properties</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Filter by Tenant</label>
<select id="receiptTenantFilter" onchange="filterReceipts()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All Tenants</option>
</select>
</div>
<button class="btn orange" onclick="clearReceiptFilters()" style="padding:10px 20px;">Show All Receipts</button>
</div>
<div id="receiptStats" style="margin-top:15px;font-weight:600;color:#666;"></div>
</div>
<table id="receiptsTable">
<thead>
<tr>
<th>Receipt #</th>
<th>Tenant</th>
<th>Phone</th>
<th>Property</th>
<th>House</th>
<th>Amount</th>
<th>Paid Date</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="expenses" class="page">
<div class="section-title">
<h2>ğŸ”§ Expenses</h2>
<div>
<button class="btn green" onclick="exportExpensesData()">ğŸ“Š Export Data</button>
</div>
</div>
<div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
<h3 style="margin:0 0 15px;font-size:16px;color:#333;">â• Add New Expense</h3>
<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;align-items:end;margin-bottom:15px;">
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Select Property *</label>
<select id="expenseProperty" onchange="updateExpenseHouseTypes()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">Select Property</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Select House Type *</label>
<select id="expenseHouseType" onchange="updateExpenseTenants()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">Select House Type</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Select Tenant *</label>
<select id="expenseTenant" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">Select Tenant</option>
</select>
</div>
</div>
<div style="background:#fff;padding:20px;border-radius:8px;margin-bottom:15px;">
<h4 style="margin:0 0 15px;font-size:14px;color:#333;">ğŸ’µ Expense Details (in Shillings)</h4>
<div style="display:grid;grid-template-columns:repeat(5, 1fr);gap:15px;">
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:12px;color:#666;">ğŸ”§ Repair</label>
<input type="number" id="expenseRepair" min="0" step="0.01" value="0" placeholder="0.00" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;" />
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:12px;color:#666;">ğŸ› ï¸ Maintenance</label>
<input type="number" id="expenseMaintenance" min="0" step="0.01" value="0" placeholder="0.00" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;" />
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:12px;color:#666;">ğŸ§¹ Cleaning</label>
<input type="number" id="expenseCleaning" min="0" step="0.01" value="0" placeholder="0.00" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;" />
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:12px;color:#666;">ğŸš¿ Plumbing</label>
<input type="number" id="expensePlumbing" min="0" step="0.01" value="0" placeholder="0.00" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;" />
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:12px;color:#666;">âš¡ Electrical</label>
<input type="number" id="expenseElectrical" min="0" step="0.01" value="0" placeholder="0.00" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;" />
</div>
</div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;">
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:12px;color:#666;">ğŸ“… Expense Date</label>
<input type="date" id="expenseDate" style="padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;" />
</div>
<div style="text-align:right;">
<div style="font-size:12px;color:#666;font-weight:600;margin-bottom:5px;">TOTAL EXPENSES</div>
<div id="expenseTotalDisplay" style="font-size:24px;font-weight:700;color:var(--red);">Ksh 0</div>
</div>
</div>
<div style="display:flex;gap:10px;justify-content:flex-end;">
<button class="btn" onclick="clearExpenseForm()">Clear Form</button>
<button id="saveExpenseBtn" class="btn green" onclick="addExpense()">ğŸ’¾ Save Expense</button>
</div>
</div>
<!-- Search/Filter Section -->
<div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
<h3 style="margin:0 0 15px;font-size:16px;color:#333;">ğŸ” Filter Expenses</h3>
<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;align-items:end;">
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Property</label>
<select id="expenseFilterProperty" onchange="updateFilterHouseTypes()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All Properties</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">House Type</label>
<select id="expenseFilterHouseType" onchange="updateFilterTenants()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All House Types</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Tenant</label>
<select id="expenseFilterTenant" onchange="filterExpenses()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All Tenants</option>
</select>
</div>
<div>
<button class="btn" onclick="clearExpenseFilters()" style="width:100%;">Clear Filters</button>
</div>
</div>
</div>
<table id="expensesTable">
<thead>
<tr>
<th>Date</th>
<th>Property</th>
<th>House Type</th>
<th>Tenant</th>
<th>Repair</th>
<th>Maintenance</th>
<th>Cleaning</th>
<th>Plumbing</th>
<th>Electrical</th>
<th>Total</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="reports" class="page">
<div class="section-title">
<h2>ğŸ“Š Monthly Property Reports</h2>
<div>
<button class="btn green" style="padding:8px 16px;font-size:13px;margin-right:10px;" onclick="generateReport()">ğŸ“Š Generate</button>
<button class="btn orange" style="padding:8px 16px;font-size:13px;margin-right:10px;" onclick="previewReport()">ğŸ‘ï¸ Preview</button>
<button class="btn" style="padding:8px 16px;font-size:13px;" onclick="exportReport()">ğŸ“¤ Export PDF</button>
</div>
</div>
<div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
<h3 style="margin:0 0 15px;font-size:16px;color:#333;">ğŸ” Report Configuration</h3>
<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;align-items:end;">
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Select Property *</label>
<select id="reportProperty" onchange="updateReportFilters()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All Properties</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Select House Type</label>
<select id="reportHouseType" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="">All House Types</option>
</select>
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Report Month *</label>
<input type="month" id="reportMonth" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;" />
</div>
<div>
<label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Report Type</label>
<select id="reportType" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
<option value="monthly">Monthly Summary</option>
<option value="detailed">Detailed Breakdown</option>
<option value="house_type">House Type Analysis</option>
<option value="financial">Financial Summary</option>
</select>
</div>
</div>
<div style="display:flex;gap:10px;margin-top:15px;justify-content:flex-end;">
<button class="btn" onclick="setCurrentMonth()">ğŸ“… Current Month</button>
<button class="btn orange" onclick="setPreviousMonth()">â¬…ï¸ Previous Month</button>
<button class="btn green" onclick="generateQuickReport()">âš¡ Quick Report</button>
</div>
<div id="reportInfo" style="margin-top:15px;padding:12px;background:#fff;border-radius:6px;font-size:13px;color:#666;font-weight:600;"></div>
</div>
<div style="background:linear-gradient(135deg,#e8f5e8,#d4edda);padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid var(--green);">
<h4 style="margin:0 0 8px;color:#155724;font-size:15px;">ğŸ†• Automated Monthly Report Features:</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;font-size:13px;color:#155724;">
<div>â€¢ <strong>ğŸ“Š Property Overview</strong> with occupancy and financial summary</div>
<div>â€¢ <strong>ğŸ  House Type Breakdown</strong> with renovation and service tracking</div>
<div>â€¢ <strong>ğŸ“„ Invoice Status</strong> - paid vs unpaid with amounts</div>
<div>â€¢ <strong>ğŸ”§ Expense Summary</strong> by service type (repair, maintenance, etc.)</div>
<div>â€¢ <strong>ğŸ’° Rent Arrears</strong> tracking and calculation</div>
<div>â€¢ <strong>ğŸ“ˆ Profit/Loss</strong> analysis per property and house type</div>
</div>
</div>
<!-- Report Summary Cards -->
<div class="stats-grid" id="reportStatsGrid" style="display:none;margin-bottom:20px;">
<div class="stat-card" style="border-left-color: var(--green);">
<div class="stat-value" id="reportTotalIncome">Ksh 0</div>
<div class="stat-label">Total Income</div>
</div>
<div class="stat-card" style="border-left-color: var(--red);">
<div class="stat-value" id="reportTotalExpenses">Ksh 0</div>
<div class="stat-label">Total Expenses</div>
</div>
<div class="stat-card" style="border-left-color: var(--blue);">
<div class="stat-value" id="reportNetProfit">Ksh 0</div>
<div class="stat-label">Net Profit</div>
</div>
<div class="stat-card" style="border-left-color: var(--orange);">
<div class="stat-value" id="reportArrears">Ksh 0</div>
<div class="stat-label">Rent Arrears</div>
</div>
</div>
<!-- Report Content Display Area -->
<div id="reportContent" style="display:none;">
<div style="background:#fff;padding:25px;border-radius:12px;box-shadow:0 2px 15px rgba(0,0,0,0.1);margin-bottom:20px;">
<h3 style="margin:0 0 20px;color:var(--black);text-align:center;">Monthly Property Report</h3>
<!-- Property Summary Section -->
<div id="propertySummary" style="margin-bottom:30px;">
<h4 style="margin:0 0 15px;color:var(--black);border-bottom:2px solid #dee2e6;padding-bottom:8px;">ğŸ“‹ Property Summary</h4>
<div id="propertySummaryContent"></div>
</div>
<!-- Invoice Status Section -->
<div id="invoiceStatus" style="margin-bottom:30px;">
<h4 style="margin:0 0 15px;color:var(--black);border-bottom:2px solid #dee2e6;padding-bottom:8px;">ğŸ“„ Invoice Status Summary</h4>
<div id="invoiceStatusContent"></div>
</div>
<!-- Expense Breakdown Section -->
<div id="expenseBreakdown" style="margin-bottom:30px;">
<h4 style="margin:0 0 15px;color:var(--black);border-bottom:2px solid #dee2e6;padding-bottom:8px;">ğŸ”§ Expense Breakdown by Category</h4>
<div id="expenseBreakdownContent"></div>
</div>
<!-- House Type Analysis Section -->
<div id="houseTypeAnalysis" style="margin-bottom:30px;">
<h4 style="margin:0 0 15px;color:var(--black);border-bottom:2px solid #dee2e6;padding-bottom:8px;">ğŸ  House Type Performance Analysis</h4>
<div id="houseTypeAnalysisContent"></div>
</div>
<!-- Rent Arrears Section -->
<div id="rentArrears" style="margin-bottom:30px;">
<h4 style="margin:0 0 15px;color:var(--black);border-bottom:2px solid #dee2e6;padding-bottom:8px;">ğŸ’° Rent Arrears Tracking</h4>
<div id="rentArrearsContent"></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="payment-modal" id="paymentModal">
<div class="payment-content">
<div class="payment-header">
<h2>ğŸ’³ Activate Your Subscription</h2>
<p>Choose your plan and complete payment via M-Pesa</p>
</div>
<div class="payment-options">
<div class="payment-option" onclick="selectPlan('monthly')" id="monthlyPlan">
<div class="period">Monthly</div>
<div class="price">Ksh 3,000</div>
<small style="color:#666;">Billed monthly</small>
</div>
<div class="payment-option" onclick="selectPlan('yearly')" id="yearlyPlan">
<div class="period">Yearly</div>
<div class="price">Ksh 20,000</div>
<div class="save">SAVE Ksh 16,000!</div>
<small style="color:#666;">Billed annually</small>
</div>
</div>
<div class="mpesa-instructions">
<h3>ğŸ“± M-Pesa Payment Instructions</h3>
<ol>
<li>Go to <strong>M-Pesa Menu</strong> on your phone</li>
... [å†…å®¹å·²æˆªæ–­: 75215 tokens -> ~32000 tokens é™åˆ¶] ...
// Show all house types if no property selected
allFilterHouseTypes.forEach(ht => {
filterHouseType.innerHTML += `<option value="${ht.id}">${ht.type_name}</option>`;
});
// Show all tenants
allFilterTenants.forEach(tenant => {
filterTenant.innerHTML += `<option value="${tenant.id}">${tenant.name} - House ${tenant.house_number}</option>`;
});
} else {
// Find house type for selected property
const selectedProperty = allFilterProperties.find(p => p.id === propertyId);
if (selectedProperty) {
const houseType = allFilterHouseTypes.find(ht => ht.id === selectedProperty.house_type_id);
if (houseType) {
filterHouseType.innerHTML += `<option value="${houseType.id}">${houseType.type_name}</option>`;
}
}
// Update tenants for this property
const filteredTenants = allFilterTenants.filter(t => t.property_id === propertyId);
filteredTenants.forEach(tenant => {
filterTenant.innerHTML += `<option value="${tenant.id}">${tenant.name} - House ${tenant.house_number}</option>`;
});
}
// Apply filter
filterExpenses();
}
// Update tenants when house type filter changes
function updateFilterTenants() {
const propertyId = document.getElementById('expenseFilterProperty').value;
const houseTypeId = document.getElementById('expenseFilterHouseType').value;
const filterTenant = document.getElementById('expenseFilterTenant');
// Reset tenant dropdown
filterTenant.innerHTML = '<option value="">All Tenants</option>';
if (!propertyId && !houseTypeId) {
// Show all tenants if nothing selected
allFilterTenants.forEach(tenant => {
filterTenant.innerHTML += `<option value="${tenant.id}">${tenant.name} - House ${tenant.house_number}</option>`;
});
} else {
// Filter tenants based on selections
let filteredTenants = allFilterTenants;
if (propertyId) {
filteredTenants = filteredTenants.filter(t => t.property_id === propertyId);
}
if (houseTypeId) {
filteredTenants = filteredTenants.filter(t => t.house_type_id === houseTypeId);
}
filteredTenants.forEach(tenant => {
filterTenant.innerHTML += `<option value="${tenant.id}">${tenant.name} - House ${tenant.house_number}</option>`;
});
}
// Apply filter
filterExpenses();
}
function filterExpenses() {
const filterPropertyId = document.getElementById('expenseFilterProperty')?.value;
const filterHouseTypeId = document.getElementById('expenseFilterHouseType')?.value;
const filterTenantId = document.getElementById('expenseFilterTenant')?.value;
let filtered = allExpenses;
// Filter by property
if (filterPropertyId) {
filtered = filtered.filter(exp => exp.property_id === filterPropertyId);
}
// Filter by house type
if (filterHouseTypeId) {
filtered = filtered.filter(exp => exp.house_type_id === filterHouseTypeId);
}
// Filter by tenant
if (filterTenantId) {
filtered = filtered.filter(exp => exp.tenant_id === filterTenantId);
}
renderExpenses(filtered);
}
function clearExpenseFilters() {
const filterProperty = document.getElementById('expenseFilterProperty');
const filterHouseType = document.getElementById('expenseFilterHouseType');
const filterTenant = document.getElementById('expenseFilterTenant');
if (filterProperty) filterProperty.value = '';
if (filterHouseType) filterHouseType.value = '';
if (filterTenant) filterTenant.value = '';
// Reset all dropdowns to show all options
populateExpenseFilterDropdowns();
renderExpenses(allExpenses);
}
// ========== REPORTS FUNCTIONALITY ==========
let reportData = {
invoices: [],
payments: [],
expenses: [],
properties: [],
tenants: [],
houseTypes: []
};
let currentReportFilters = {
propertyId: '',
houseTypeId: '',
reportMonth: '',
reportType: 'monthly'
};
async function showReports() {
await populateReportFilters();
loadReportData();
}
async function populateReportFilters() {
try {
// Load properties
const { data: properties } = await supabase
.from('properties')
.select('id, name')
.eq('user_id', currentUser.id)
.order('name');
const propertySelect = document.getElementById('reportProperty');
propertySelect.innerHTML = '<option value="">All Properties</option>';
if (properties) {
properties.forEach(prop => {
propertySelect.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
});
}
// Load house types
const { data: houseTypes } = await supabase
.from('house_types')
.select('id, type_name')
.eq('user_id', currentUser.id)
.order('type_name');
const houseTypeSelect = document.getElementById('reportHouseType');
houseTypeSelect.innerHTML = '<option value="">All House Types</option>';
if (houseTypes) {
houseTypes.forEach(ht => {
houseTypeSelect.innerHTML += `<option value="${ht.id}">${ht.type_name}</option>`;
});
}
// Set current month as default
const now = new Date();
const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
document.getElementById('reportMonth').value = currentMonthYear;
} catch (error) {
console.error('Error loading report filters:', error);
}
}
function updateReportFilters() {
// Update filter variables
currentReportFilters.propertyId = document.getElementById('reportProperty').value;
currentReportFilters.houseTypeId = document.getElementById('reportHouseType').value;
currentReportFilters.reportMonth = document.getElementById('reportMonth').value;
currentReportFilters.reportType = document.getElementById('reportType').value;
updateReportInfo();
}
async function loadReportData() {
try {
showLoading();
// Load all report data
const [invoicesResult, paymentsResult, expensesResult, propertiesResult, tenantsResult, houseTypesResult] = await Promise.all([
supabase.from('invoices').select(`
*,
tenants(name, house_number, property_id, house_type_id),
properties(name)
`).eq('user_id', currentUser.id),
supabase.from('payments').select(`
*,
tenants(name, house_number, property_id, house_type_id)
`).eq('user_id', currentUser.id),
supabase.from('expenses').select(`
*,
tenants(name, house_number, property_id),
properties(name),
house_types(type_name)
`).eq('user_id', currentUser.id),
supabase.from('properties').select('*').eq('user_id', currentUser.id),
supabase.from('tenants').select('*').eq('user_id', currentUser.id),
supabase.from('house_types').select('*').eq('user_id', currentUser.id)
]);
reportData.invoices = invoicesResult.data || [];
reportData.payments = paymentsResult.data || [];
reportData.expenses = expensesResult.data || [];
reportData.properties = propertiesResult.data || [];
reportData.tenants = tenantsResult.data || [];
reportData.houseTypes = houseTypesResult.data || [];
updateReportInfo();
} catch (error) {
console.error('Error loading report data:', error);
alert('Error loading report data: ' + error.message);
} finally {
hideLoading();
}
}
function updateReportInfo() {
const propertyName = currentReportFilters.propertyId ? 
reportData.properties.find(p => p.id == currentReportFilters.propertyId)?.name || 'Unknown' : 'All Properties';
const houseTypeName = currentReportFilters.houseTypeId ?
reportData.houseTypes.find(ht => ht.id == currentReportFilters.houseTypeId)?.type_name || 'Unknown' : 'All House Types';
const monthName = getMonthName(currentReportFilters.reportMonth);
// Calculate expected data counts for the selected filters
const [year, month] = currentReportFilters.reportMonth.split('-');
const expectedInvoices = getExpectedInvoiceCount(year, month);
const expectedExpenses = getExpectedExpenseCount(year, month);
const infoText = `ğŸ“Š Report for: ${propertyName} | ${houseTypeName} | ${monthName} | Type: ${currentReportFilters.reportType} | Expected: ${expectedInvoices} invoices, ${expectedExpenses} expenses`;
document.getElementById('reportInfo').textContent = infoText;
}
function getExpectedInvoiceCount(year, month) {
if (!reportData.invoices.length) return 0;
return reportData.invoices.filter(invoice => {
if (!invoice.invoice_period) return false;
const [invYear, invMonth] = invoice.invoice_period.split(' ');
return invYear === year && getMonthNumber(invMonth) === parseInt(month);
}).length;
}
function getExpectedExpenseCount(year, month) {
if (!reportData.expenses.length) return 0;
return reportData.expenses.filter(expense => {
if (!expense.date) return false;
const expenseDate = new Date(expense.date);
return expenseDate.getFullYear() === parseInt(year) && 
(expenseDate.getMonth() + 1) === parseInt(month);
}).length;
}
function getMonthName(monthStr) {
if (!monthStr) return 'No Month Selected';
const [year, month] = monthStr.split('-');
const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
'July', 'August', 'September', 'October', 'November', 'December'];
return `${monthNames[parseInt(month) - 1]} ${year}`;
}
function setCurrentMonth() {
const now = new Date();
const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
document.getElementById('reportMonth').value = currentMonthYear;
updateReportFilters();
}
function setPreviousMonth() {
const now = new Date();
const previousMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
const monthYear = `${previousMonth.getFullYear()}-${String(previousMonth.getMonth() + 1).padStart(2, '0')}`;
document.getElementById('reportMonth').value = monthYear;
updateReportFilters();
}
async function generateQuickReport() {
if (!currentReportFilters.reportMonth) {
alert('Please select a month for the report!');
return;
}
await generateReport(true); // quick mode
}
async function generateReport(previewMode = false) {
if (!currentReportFilters.reportMonth) {
alert('Please select a month for the report!');
return;
}
try {
showLoading();
const reportMonth = currentReportFilters.reportMonth;
const [year, month] = reportMonth.split('-');
// Filter data based on current filters
const filteredInvoices = await getFilteredInvoices(year, month);
const filteredPayments = await getFilteredPayments(year, month);
const filteredExpenses = await getFilteredExpenses(year, month);
// Generate report statistics
const reportStats = generateReportStatistics(filteredInvoices, filteredPayments, filteredExpenses);
// Display report
displayReport(reportStats, filteredInvoices, filteredPayments, filteredExpenses);
if (!previewMode) {
alert('âœ… Report generated successfully!');
}
} catch (error) {
console.error('Error generating report:', error);
alert('Error generating report: ' + error.message);
} finally {
hideLoading();
}
}
async function getFilteredInvoices(year, month) {
let invoices = [...reportData.invoices];
// Filter by date range (selected month)
invoices = invoices.filter(invoice => {
if (!invoice.invoice_period) return false;
const [invYear, invMonth] = invoice.invoice_period.split(' ');
return invYear === year && getMonthNumber(invMonth) === parseInt(month);
});
// Filter by property
if (currentReportFilters.propertyId) {
invoices = invoices.filter(invoice => 
invoice.tenants?.property_id === currentReportFilters.propertyId
);
}
// Filter by house type
if (currentReportFilters.houseTypeId) {
invoices = invoices.filter(invoice => 
invoice.tenants?.house_type_id === currentReportFilters.houseTypeId
);
}
return invoices;
}
async function getFilteredPayments(year, month) {
let payments = [...reportData.payments];
// Filter by payment date (selected month)
payments = payments.filter(payment => {
if (!payment.payment_date) return false;
const paymentDate = new Date(payment.payment_date);
return paymentDate.getFullYear() === parseInt(year) && 
(paymentDate.getMonth() + 1) === parseInt(month);
});
// Filter by property
if (currentReportFilters.propertyId) {
payments = payments.filter(payment => 
payment.tenants?.property_id === currentReportFilters.propertyId
);
}
// Filter by house type
if (currentReportFilters.houseTypeId) {
payments = payments.filter(payment => 
payment.tenants?.house_type_id === currentReportFilters.houseTypeId
);
}
return payments;
}
async function getFilteredExpenses(year, month) {
let expenses = [...reportData.expenses];
// Filter by expense date (selected month)
expenses = expenses.filter(expense => {
if (!expense.date) return false;
const expenseDate = new Date(expense.date);
return expenseDate.getFullYear() === parseInt(year) && 
(expenseDate.getMonth() + 1) === parseInt(month);
});
// Filter by property
if (currentReportFilters.propertyId) {
expenses = expenses.filter(expense => expense.property_id === currentReportFilters.propertyId);
}
// Filter by house type
if (currentReportFilters.houseTypeId) {
expenses = expenses.filter(expense => expense.house_type_id === currentReportFilters.houseTypeId);
}
return expenses;
}
function getMonthNumber(monthName) {
const monthNames = {
'January': 1, 'February': 2, 'March': 3, 'April': 4,
'May': 5, 'June': 6, 'July': 7, 'August': 8,
'September': 9, 'October': 10, 'November': 11, 'December': 12
};
return monthNames[monthName] || 0;
}
function generateReportStatistics(invoices, payments, expenses) {
const stats = {
totalIncome: 0,
totalExpenses: 0,
netProfit: 0,
totalArrears: 0,
paidInvoices: 0,
pendingInvoices: 0,
overdueInvoices: 0,
propertyBreakdown: {},
houseTypeBreakdown: {},
expenseBreakdown: {}
};
// Calculate income from payments
stats.totalIncome = payments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
// Calculate expenses
stats.totalExpenses = expenses.reduce((sum, expense) => sum + parseFloat(expense.total || 0), 0);
stats.netProfit = stats.totalIncome - stats.totalExpenses;
// Invoice status analysis
invoices.forEach(invoice => {
const amount = parseFloat(invoice.amount || 0);
switch (invoice.status?.toLowerCase()) {
case 'paid':
stats.paidInvoices++;
break;
case 'pending':
case 'sent':
stats.pendingInvoices++;
stats.totalArrears += amount;
break;
case 'overdue':
stats.overdueInvoices++;
stats.totalArrears += amount;
break;
}
// Property breakdown
const propertyName = invoice.tenants?.property_name || invoice.properties?.name || 'Unknown';
if (!stats.propertyBreakdown[propertyName]) {
stats.propertyBreakdown[propertyName] = {
income: 0,
expenses: 0,
invoices: 0,
paid: 0,
pending: 0
};
}
if (invoice.status?.toLowerCase() === 'paid') {
stats.propertyBreakdown[propertyName].income += amount;
stats.propertyBreakdown[propertyName].paid++;
} else {
stats.propertyBreakdown[propertyName].pending++;
}
stats.propertyBreakdown[propertyName].invoices++;
});
// House type breakdown
invoices.forEach(invoice => {
const houseTypeName = invoice.tenants?.house_type_name || 'Unknown';
if (!stats.houseTypeBreakdown[houseTypeName]) {
stats.houseTypeBreakdown[houseTypeName] = {
income: 0,
expenses: 0,
invoices: 0,
paid: 0,
pending: 0
};
}
const amount = parseFloat(invoice.amount || 0);
if (invoice.status?.toLowerCase() === 'paid') {
stats.houseTypeBreakdown[houseTypeName].income += amount;
stats.houseTypeBreakdown[houseTypeName].paid++;
} else {
stats.houseTypeBreakdown[houseTypeName].pending++;
}
stats.houseTypeBreakdown[houseTypeName].invoices++;
});
// Expense breakdown by category
expenses.forEach(expense => {
const propertyName = expense.tenants?.property_name || expense.properties?.name || 'Unknown';
if (!stats.expenseBreakdown[propertyName]) {
stats.expenseBreakdown[propertyName] = {
repair: 0,
maintenance: 0,
cleaning: 0,
plumbing: 0,
electrical: 0,
total: 0
};
}
stats.expenseBreakdown[propertyName].repair += parseFloat(expense.repair || 0);
stats.expenseBreakdown[propertyName].maintenance += parseFloat(expense.maintenance || 0);
stats.expenseBreakdown[propertyName].cleaning += parseFloat(expense.cleaning || 0);
stats.expenseBreakdown[propertyName].plumbing += parseFloat(expense.plumbing || 0);
stats.expenseBreakdown[propertyName].electrical += parseFloat(expense.electrical || 0);
stats.expenseBreakdown[propertyName].total += parseFloat(expense.total || 0);
});
return stats;
}
function displayReport(stats, invoices, payments, expenses) {
// Show stats grid
document.getElementById('reportStatsGrid').style.display = 'grid';
// Update stats cards
document.getElementById('reportTotalIncome').textContent = `Ksh ${stats.totalIncome.toLocaleString()}`;
document.getElementById('reportTotalExpenses').textContent = `Ksh ${stats.totalExpenses.toLocaleString()}`;
document.getElementById('reportNetProfit').textContent = `Ksh ${stats.netProfit.toLocaleString()}`;
document.getElementById('reportArrears').textContent = `Ksh ${stats.totalArrears.toLocaleString()}`;
// Color code profit/loss
const profitElement = document.getElementById('reportNetProfit');
if (stats.netProfit >= 0) {
profitElement.style.color = 'var(--green)';
} else {
profitElement.style.color = 'var(--red)';
}
// Show report content
document.getElementById('reportContent').style.display = 'block';
// Populate sections
displayPropertySummary(stats, invoices, payments, expenses);
displayInvoiceStatus(invoices);
displayExpenseBreakdown(stats);
displayHouseTypeAnalysis(stats);
displayRentArrears(stats, invoices);
}
function displayPropertySummary(stats, invoices, payments, expenses) {
const content = document.getElementById('propertySummaryContent');
const totalProperties = Object.keys(stats.propertyBreakdown).length;
const totalInvoices = invoices.length;
const totalPayments = payments.length;
const totalExpenses = expenses.length;
content.innerHTML = `
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
<div style="background:#f8f9fa;padding:15px;border-radius:8px;">
<h5 style="margin:0 0 10px;color:#333;">ğŸ“Š Overview</h5>
<p><strong>Properties:</strong> ${totalProperties}</p>
<p><strong>Invoices:</strong> ${totalInvoices}</p>
<p><strong>Payments:</strong> ${totalPayments}</p>
<p><strong>Expenses:</strong> ${totalExpenses}</p>
</div>
<div style="background:#f8f9fa;padding:15px;border-radius:8px;">
<h5 style="margin:0 0 10px;color:#333;">ğŸ’° Financial Summary</h5>
<p><strong>Total Income:</strong> Ksh ${stats.totalIncome.toLocaleString()}</p>
<p><strong>Total Expenses:</strong> Ksh ${stats.totalExpenses.toLocaleString()}</p>
<p><strong>Net Profit:</strong> <span style="color:${stats.netProfit >= 0 ? 'var(--green)' : 'var(--red)'}">Ksh ${stats.netProfit.toLocaleString()}</span></p>
<p><strong>Profit Margin:</strong> ${stats.totalIncome > 0 ? ((stats.netProfit / stats.totalIncome) * 100).toFixed(1) : 0}%</p>
</div>
</div>
`;
}
function displayInvoiceStatus(invoices) {
const content = document.getElementById('invoiceStatusContent');
if (invoices.length === 0) {
content.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No invoices found for the selected period.</p>';
return;
}
const paidInvoices = invoices.filter(inv => inv.status?.toLowerCase() === 'paid');
const pendingInvoices = invoices.filter(inv => inv.status?.toLowerCase() === 'pending' || inv.status?.toLowerCase() === 'sent');
const overdueInvoices = invoices.filter(inv => inv.status?.toLowerCase() === 'overdue');
const totalAmount = invoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0);
const paidAmount = paidInvoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0);
const pendingAmount = pendingInvoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0);
const overdueAmount = overdueInvoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0);
content.innerHTML = `
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;">
<div style="text-align:center;padding:15px;background:var(--green);color:#fff;border-radius:8px;">
<h4 style="margin:0;font-size:24px;">${paidInvoices.length}</h4>
<p style="margin:5px 0 0;font-size:12px;">PAID INVOICES</p>
<p style="margin:0;font-size:14px;font-weight:600;">Ksh ${paidAmount.toLocaleString()}</p>
</div>
<div style="text-align:center;padding:15px;background:var(--orange);color:#fff;border-radius:8px;">
<h4 style="margin:0;font-size:24px;">${pendingInvoices.length}</h4>
<p style="margin:5px 0 0;font-size:12px;">PENDING INVOICES</p>
<p style="margin:0;font-size:14px;font-weight:600;">Ksh ${pendingAmount.toLocaleString()}</p>
</div>
<div style="text-align:center;padding:15px;background:var(--red);color:#fff;border-radius:8px;">
<h4 style="margin:0;font-size:24px;">${overdueInvoices.length}</h4>
<p style="margin:5px 0 0;font-size:12px;">OVERDUE INVOICES</p>
<p style="margin:0;font-size:14px;font-weight:600;">Ksh ${overdueAmount.toLocaleString()}</p>
</div>
<div style="text-align:center;padding:15px;background:var(--blue);color:#fff;border-radius:8px;">
<h4 style="margin:0;font-size:24px;">${invoices.length}</h4>
<p style="margin:5px 0 0;font-size:12px;">TOTAL INVOICES</p>
<p style="margin:0;font-size:14px;font-weight:600;">Ksh ${totalAmount.toLocaleString()}</p>
</div>
</div>
<div style="background:#fff;border:1px solid #dee2e6;border-radius:8px;overflow:hidden;">
<table style="width:100%;border-collapse:collapse;">
<thead>
<tr style="background:#f8f9fa;">
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Invoice #</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Tenant</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Property</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Amount</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Status</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Due Date</th>
</tr>
</thead>
<tbody>
${invoices.slice(0, 10).map(invoice => `
<tr>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">${invoice.invoice_number || 'N/A'}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">${invoice.tenants?.name || 'N/A'}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">${invoice.tenants?.property_name || invoice.properties?.name || 'N/A'}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">Ksh ${Number(invoice.amount || 0).toLocaleString()}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">
<span class="status-badge status-${invoice.status?.toLowerCase() || 'pending'}">${invoice.status || 'Pending'}</span>
</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">${invoice.due_date || 'N/A'}</td>
</tr>
`).join('')}
</tbody>
</table>
${invoices.length > 10 ? `<p style="padding:10px;margin:0;background:#f8f9fa;text-align:center;color:#666;">... and ${invoices.length - 10} more invoices</p>` : ''}
</div>
`;
}
function displayExpenseBreakdown(stats) {
const content = document.getElementById('expenseBreakdownContent');
if (Object.keys(stats.expenseBreakdown).length === 0) {
content.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No expenses found for the selected period.</p>';
return;
}
let totalRepair = 0, totalMaintenance = 0, totalCleaning = 0, totalPlumbing = 0, totalElectrical = 0;
const propertyBreakdown = Object.entries(stats.expenseBreakdown).map(([property, breakdown]) => {
totalRepair += breakdown.repair;
totalMaintenance += breakdown.maintenance;
totalCleaning += breakdown.cleaning;
totalPlumbing += breakdown.plumbing;
totalElectrical += breakdown.electrical;
return `
<tr>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;"><strong>${property}</strong></td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">Ksh ${Number(breakdown.repair).toLocaleString()}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">Ksh ${Number(breakdown.maintenance).toLocaleString()}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">Ksh ${Number(breakdown.cleaning).toLocaleString()}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">Ksh ${Number(breakdown.plumbing).toLocaleString()}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">Ksh ${Number(breakdown.electrical).toLocaleString()}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;font-weight:600;">Ksh ${Number(breakdown.total).toLocaleString()}</td>
</tr>
`;
}).join('');
content.innerHTML = `
<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px;">
<div style="text-align:center;padding:10px;background:#fff;border:2px solid #e9ecef;border-radius:8px;">
<h5 style="margin:0 0 5px;color:var(--red);">ğŸ”§ Repair</h5>
<p style="margin:0;font-size:18px;font-weight:700;">Ksh ${totalRepair.toLocaleString()}</p>
</div>
<div style="text-align:center;padding:10px;background:#fff;border:2px solid #e9ecef;border-radius:8px;">
<h5 style="margin:0 0 5px;color:var(--orange);">ğŸ› ï¸ Maintenance</h5>
<p style="margin:0;font-size:18px;font-weight:700;">Ksh ${totalMaintenance.toLocaleString()}</p>
</div>
<div style="text-align:center;padding:10px;background:#fff;border:2px solid #e9ecef;border-radius:8px;">
<h5 style="margin:0 0 5px;color:var(--blue);">ğŸ§¹ Cleaning</h5>
<p style="margin:0;font-size:18px;font-weight:700;">Ksh ${totalCleaning.toLocaleString()}</p>
</div>
<div style="text-align:center;padding:10px;background:#fff;border:2px solid #e9ecef;border-radius:8px;">
<h5 style="margin:0 0 5px;color:var(--purple);">ğŸš¿ Plumbing</h5>
<p style="margin:0;font-size:18px;font-weight:700;">Ksh ${totalPlumbing.toLocaleString()}</p>
</div>
<div style="text-align:center;padding:10px;background:#fff;border:2px solid #e9ecef;border-radius:8px;">
<h5 style="margin:0 0 5px;color:var(--green);">âš¡ Electrical</h5>
<p style="margin:0;font-size:18px;font-weight:700;">Ksh ${totalElectrical.toLocaleString()}</p>
</div>
</div>
<div style="background:#fff;border:1px solid #dee2e6;border-radius:8px;overflow:hidden;">
<table style="width:100%;border-collapse:collapse;">
<thead>
<tr style="background:#f8f9fa;">
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Property</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Repair</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Maintenance</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Cleaning</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Plumbing</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Electrical</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Total</th>
</tr>
</thead>
<tbody>
${propertyBreakdown}
</tbody>
</table>
</div>
`;
}
function displayHouseTypeAnalysis(stats) {
const content = document.getElementById('houseTypeAnalysisContent');
if (Object.keys(stats.houseTypeBreakdown).length === 0) {
content.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No house type data found for the selected period.</p>';
return;
}
const houseTypeBreakdown = Object.entries(stats.houseTypeBreakdown).map(([houseType, breakdown]) => {
const profit = breakdown.income - (stats.expenseBreakdown[Object.keys(stats.expenseBreakdown)[0]]?.total || 0);
const occupancyRate = breakdown.invoices > 0 ? ((breakdown.paid / breakdown.invoices) * 100).toFixed(1) : 0;
return `
<tr>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;"><strong>${houseType}</strong></td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">${breakdown.invoices}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">${breakdown.paid}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">${breakdown.pending}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">${occupancyRate}%</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;">Ksh ${Number(breakdown.income).toLocaleString()}</td>
<td style="padding:10px;border-bottom:1px solid #f1f3f4;color:${profit >= 0 ? 'var(--green)' : 'var(--red)'}">Ksh ${profit.toLocaleString()}</td>
</tr>
`;
}).join('');
content.innerHTML = `
<div style="background:#fff;border:1px solid #dee2e6;border-radius:8px;overflow:hidden;">
<table style="width:100%;border-collapse:collapse;">
<thead>
<tr style="background:#f8f9fa;">
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">House Type</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Total Units</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Paid Units</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Pending Units</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Occupancy Rate</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Income Generated</th>
<th style="padding:12px;text-align:left;border-bottom:1px solid #dee2e6;">Net Profit</th>
</tr>
</thead>
<tbody>
${houseTypeBreakdown}
</tbody>
</table>
</div>
`;
}
function displayRentArrears(stats, invoices) {
const content = document.getElementById('rentArrearsContent');
const overdueInvoices = invoices.filter(inv => 
inv.status?.toLowerCase() === 'overdue' || 
(inv.status?.toLowerCase() === 'pending' && new Date(inv.due_date) < new Date())
);
const pendingInvoices = invoices.filter(inv => 
inv.status?.toLowerCase() === 'pending' || inv.status?.toLowerCase() === 'sent'
);
const totalOverdueAmount = overdueInvoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0);
const totalPendingAmount = pendingInvoices.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0);
content.innerHTML = `
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;">
<div style="text-align:center;padding:15px;background:var(--red);color:#fff;border-radius:8px;">
<h4 style="margin:0;font-size:20px;">Ksh ${totalOverdueAmount.toLocaleString()}</h4>
<p style="margin:5px 0 0;font-size:12px;">OVERDUE AMOUNT</p>
<p style="margin:0;font-size:14px;">${overdueInvoices.length} invoices</p>
</div>
<div style="text-align:center;padding:15px;background:var(--orange);color:#fff;border-radius:8px;">
<h4 style="margin:0;font-size:20px;">Ksh ${totalPendingAmount.toLocaleString()}</h4>
<p style="margin:5px 0 0;font-size:12px;">PENDING AMOUNT</p>
<p style="margin:0;font-size:14px;">${pendingInvoices.length} invoices</p>
</div>
<div style="text-align:center;padding:15px;background:var(--blue);color:#fff;border-radius:8px;">
<h4 style="margin:0;font-size:20px;">Ksh ${stats.totalArrears.toLocaleString()}</h4>
<p style="margin:5px 0 0;font-size:12px;">TOTAL ARREARS</p>
<p style="margin:0;font-size:14px;">All outstanding</p>
</div>
</div>
<div style="background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:15px;">
<h5 style="margin:0 0 15px;color:#333;">ğŸ“‹ Outstanding Invoices</h5>
${overdueInvoices.slice(0, 5).map(invoice => `
<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #f1f3f4;">
<div>
<strong>${invoice.invoice_number || 'N/A'}</strong> - ${invoice.tenants?.name || 'Unknown Tenant'}
<br><small style="color:#666;">${invoice.tenants?.property_name || invoice.properties?.name || 'Unknown Property'}</small>
</div>
<div style="text-align:right;">
<div style="font-weight:600;color:var(--red)">Ksh ${Number(invoice.amount || 0).toLocaleString()}</div>
<small style="color:#666;">Due: ${invoice.due_date}</small>
</div>
</div>
`).join('')}
${overdueInvoices.length > 5 ? `<p style="text-align:center;padding:10px;margin:0;background:#f8f9fa;color:#666;">... and ${overdueInvoices.length - 5} more outstanding invoices</p>` : ''}
</div>
`;
}
function previewReport() {
if (!currentReportFilters.reportMonth) {
alert('Please select a month for the preview!');
return;
}
generateReport(true); // preview mode
}
async function exportReport() {
if (document.getElementById('reportContent').style.display === 'none') {
alert('Please generate a report first!');
return;
}
try {
showLoading();
const { jsPDF } = window.jspdf;
const doc = new jsPDF();
const pageWidth = doc.internal.pageSize.width;
// Header
doc.setFontSize(20);
doc.setFont(undefined, 'bold');
doc.text('RENT POA', pageWidth / 2, 20, { align: 'center' });
doc.setFontSize(16);
doc.text('Monthly Property Report', pageWidth / 2, 35, { align: 'center' });
// Report details
doc.setFontSize(12);
doc.setFont(undefined, 'normal');
const propertyName = currentReportFilters.propertyId ? 
reportData.properties.find(p => p.id == currentReportFilters.propertyId)?.name || 'Unknown' : 'All Properties';
const monthName = getMonthName(currentReportFilters.reportMonth);
let yPos = 50;
doc.text(`Property: ${propertyName}`, 20, yPos);
doc.text(`Period: ${monthName}`, 20, yPos + 10);
doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, yPos + 20);
// === FINANCIAL SUMMARY SECTION ===
yPos += 40;
doc.setFontSize(14);
doc.setFont(undefined, 'bold');
doc.text('FINANCIAL SUMMARY', 20, yPos);
yPos += 10;
doc.setFontSize(12);
doc.setFont(undefined, 'normal');
const totalIncome = document.getElementById('reportTotalIncome').textContent;
const totalExpenses = document.getElementById('reportTotalExpenses').textContent;
const netProfit = document.getElementById('reportNetProfit').textContent;
const totalArrears = document.getElementById('reportArrears').textContent;
doc.text(`Total Income: ${totalIncome}`, 20, yPos);
doc.text(`Total Expenses: ${totalExpenses}`, 20, yPos + 7);
doc.text(`Net Profit: ${netProfit}`, 20, yPos + 14);
doc.text(`Total Arrears: ${totalArrears}`, 20, yPos + 21);
// === PROPERTY SUMMARY SECTION ===
yPos += 35;
if (yPos > 250) {
doc.addPage();
yPos = 20;
}
doc.setFontSize(14);
doc.setFont(undefined, 'bold');
doc.text('PROPERTY SUMMARY', 20, yPos);
yPos += 10;
doc.setFontSize(11);
doc.setFont(undefined, 'normal');
const propertySummary = document.getElementById('propertySummaryContent');
if (propertySummary) {
const summaryText = propertySummary.textContent || 'Property summary data available';
const lines = doc.splitTextToSize(summaryText, pageWidth - 40);
doc.text(lines, 20, yPos);
yPos += lines.length * 5 + 10;
}
// === INVOICE STATUS SECTION ===
if (yPos > 250) {
doc.addPage();
yPos = 20;
}
doc.setFontSize(14);
doc.setFont(undefined, 'bold');
doc.text('INVOICE STATUS SUMMARY', 20, yPos);
yPos += 10;
doc.setFontSize(11);
doc.setFont(undefined, 'normal');
const invoiceStatus = document.getElementById('invoiceStatusContent');
if (invoiceStatus) {
const invoiceText = invoiceStatus.textContent || 'Invoice status data available';
const lines = doc.splitTextToSize(invoiceText, pageWidth - 40);
doc.text(lines, 20, yPos);
yPos += lines.length * 5 + 10;
}
// === EXPENSE BREAKDOWN SECTION ===
if (yPos > 250) {
doc.addPage();
yPos = 20;
}
doc.setFontSize(14);
doc.setFont(undefined, 'bold');
doc.text('EXPENSE BREAKDOWN BY CATEGORY', 20, yPos);
yPos += 10;
doc.setFontSize(11);
doc.setFont(undefined, 'normal');
const expenseBreakdown = document.getElementById('expenseBreakdownContent');
if (expenseBreakdown) {
const expenseText = expenseBreakdown.textContent || 'Expense breakdown data available';
const lines = doc.splitTextToSize(expenseText, pageWidth - 40);
doc.text(lines, 20, yPos);
yPos += lines.length * 5 + 10;
}
// === HOUSE TYPE ANALYSIS SECTION ===
if (yPos > 250) {
doc.addPage();
yPos = 20;
}
doc.setFontSize(14);
doc.setFont(undefined, 'bold');
doc.text('HOUSE TYPE PERFORMANCE ANALYSIS', 20, yPos);
yPos += 10;
doc.setFontSize(11);
doc.setFont(undefined, 'normal');
const houseTypeAnalysis = document.getElementById('houseTypeAnalysisContent');
if (houseTypeAnalysis) {
const houseTypeText = houseTypeAnalysis.textContent || 'House type analysis data available';
const lines = doc.splitTextToSize(houseTypeText, pageWidth - 40);
doc.text(lines, 20, yPos);
yPos += lines.length * 5 + 10;
}
// === RENT ARREARS SECTION ===
if (yPos > 250) {
doc.addPage();
yPos = 20;
}
doc.setFontSize(14);
doc.setFont(undefined, 'bold');
doc.text('RENT ARREARS TRACKING', 20, yPos);
yPos += 10;
doc.setFontSize(11);
doc.setFont(undefined, 'normal');
const rentArrears = document.getElementById('rentArrearsContent');
if (rentArrears) {
const arrearsText = rentArrears.textContent || 'Rent arrears data available';
const lines = doc.splitTextToSize(arrearsText, pageWidth - 40);
doc.text(lines, 20, yPos);
}
// Footer
doc.setFontSize(9);
doc.setFont(undefined, 'italic');
doc.text('Generated by RentPoa Property Management System', pageWidth / 2, 290, { align: 'center' });
const fileName = `Property_Report_${propertyName.replace(/\s+/g, '_')}_${currentReportFilters.reportMonth}.pdf`;
doc.save(fileName);
alert('âœ… Complete report exported to PDF successfully!');
} catch (error) {
console.error('Error exporting report:', error);
alert('Error exporting report: ' + error.message);
} finally {
hideLoading();
}
}
// Event listeners for report filters
document.addEventListener('DOMContentLoaded', function() {
const reportFilters = ['reportProperty', 'reportHouseType', 'reportMonth', 'reportType'];
reportFilters.forEach(filterId => {
const element = document.getElementById(filterId);
if (element) {
element.addEventListener('change', updateReportFilters);
}
});
});
// ========== END REPORTS FUNCTIONALITY ==========
async function exportExpensesData() {
try {
showLoading();
if (allExpenses.length === 0) {
alert('No expenses to export');
return;
}
const { jsPDF } = window.jspdf;
const doc = new jsPDF('landscape');
doc.setFontSize(20);
doc.text('Expenses Report', 14, 20);
doc.setFontSize(10);
doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);
doc.text(`Total Expenses: ${allExpenses.length}`, 14, 35);
const tableData = allExpenses.map(expense => [
expense.date,
expense.properties?.name || 'N/A',
expense.house_types?.type_name || 'N/A',
expense.tenants?.name || 'N/A',
`Ksh ${Number(expense.repair || 0).toLocaleString()}`,
`Ksh ${Number(expense.maintenance || 0).toLocaleString()}`,
`Ksh ${Number(expense.cleaning || 0).toLocaleString()}`,
`Ksh ${Number(expense.plumbing || 0).toLocaleString()}`,
`Ksh ${Number(expense.electrical || 0).toLocaleString()}`,
`Ksh ${Number(expense.total || 0).toLocaleString()}`
]);
doc.autoTable({
startY: 42,
head: [['Date', 'Property', 'House Type', 'Tenant', 'Repair', 'Maintenance', 'Cleaning', 'Plumbing', 'Electrical', 'Total']],
body: tableData,
theme: 'striped',
headStyles: { fillColor: [11, 11, 11] },
styles: { fontSize: 7 }
});
const totalAmount = allExpenses.reduce((sum, exp) => sum + parseFloat(exp.total || 0), 0);
const finalY = doc.lastAutoTable.finalY + 10;
doc.setFontSize(12);
doc.text(`Grand Total: Ksh ${totalAmount.toLocaleString()}`, 14, finalY);
doc.save(`Expenses_Report_${new Date().toISOString().split('T')[0]}.pdf`);
alert('âœ… Expenses report exported successfully!');
} catch (error) {
alert('Error: ' + error.message);
} finally {
hideLoading();
}
}
</script>
</body>
</html>