<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>RentPoa - Property Management</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{--black:#0b0b0b;--red:#c0392b;--green:#27ae60;--blue:#3498db;--orange:#f39c12;--purple:#9b59b6;}
  *{box-sizing:border-box}
  body,html{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  
  .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999;}
  .loading-overlay.show{display:flex;}
  .spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;}
  @keyframes spin{0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}
  
  #loginScreen, #signupScreen{height:100vh;background:url("https://images.unsplash.com/photo-1568605114967-8130f3a36994?auto=format&fit=crop&w=1600&q=80") center/cover no-repeat;display:flex;align-items:center;justify-content:center}
  #signupScreen{display:none}
  
  .authCard{width:500px;background:rgba(0,0,0,0.85);padding:32px;border-radius:12px;color:#fff;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
  .authCard h2{margin:0 0 20px;font-size:24px}
  .authCard input{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#fff;font-size:14px}
  .authCard input::placeholder{color:rgba(255,255,255,0.7)}
  .authCard input:focus{outline:none;border-color:var(--blue);background:rgba(255,255,255,0.15)}
  
  .btn{background:var(--blue);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;margin:8px 4px;transition:all 0.3s ease;font-size:14px}
  .btn:hover{background:#2980b9}
  .btn.red{background:var(--red)}
  .btn.red:hover{background:#a93226}
  .btn.green{background:var(--green)}
  .btn.green:hover{background:#229954}
  .btn.orange{background:var(--orange)}
  .btn.orange:hover{background:#d68910}
  
  .error, .success{padding:12px;border-radius:8px;margin:12px 0;font-weight:600;display:none}
  .error{background:rgba(192,57,43,0.9);color:#fff}
  .success{background:rgba(39,174,96,0.9);color:#fff}
  
  #app{display:none;height:100vh;overflow:hidden}
  
  .header{background:var(--black);color:#fff;padding:0;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
  .logo{font-weight:700;font-size:20px;padding:15px 20px}
  
  .hamburger{display:none;flex-direction:column;justify-content:space-around;width:24px;height:20px;background:transparent;border:none;cursor:pointer;padding:0;margin-left:15px}
  .hamburger span{display:block;height:3px;width:100%;background:#fff;border-radius:2px;transition:all 0.3s ease}
  .hamburger.open span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}
  .hamburger.open span:nth-child(2){opacity:0}
  .hamburger.open span:nth-child(3){transform:rotate(-45deg) translate(7px,-6px)}
  
  .header-left{display:flex;align-items:center}
  
  .user-info{display:flex;align-items:center;gap:15px;padding:15px 20px}
  .logout-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 12px;border-radius:4px;cursor:pointer;transition:all 0.3s ease;font-size:12px}
  .logout-btn:hover{background:rgba(255,255,255,0.1)}
  
  .trial-banner{background:linear-gradient(135deg, var(--orange), var(--red));color:#fff;padding:10px 20px;text-align:center;font-weight:600;box-shadow:0 2px 5px rgba(0,0,0,0.2);animation:pulse 2s infinite;}
  @keyframes pulse{0%, 100%{opacity:1} 50%{opacity:0.8}}
  
  .subscription-badge{background:var(--green);color:#fff;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;}
  .subscription-badge.trial{background:var(--orange);}
  .subscription-badge.owner{background:linear-gradient(135deg, #9b59b6, #8e44ad);color:#fff;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;box-shadow:0 2px 8px rgba(155, 89, 182, 0.4);}
  .subscription-badge.expired{background:var(--red);}
  
  .content{display:flex;height:calc(100vh - 60px)}
  
  .sidebar{width:250px;background:linear-gradient(180deg,#2c3e50 0%,#34495e 100%);overflow-y:auto}
  .nav-item{padding:15px 20px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.1);transition:background 0.3s ease;color:rgba(255,255,255,0.8);font-weight:500}
  .nav-item:hover{background:rgba(255,255,255,0.1);color:#fff}
  .nav-item.active{background:var(--blue);color:#fff;border-left:4px solid #fff}
  
  #mainSection{flex:1;padding:25px;overflow-y:auto;background:#fff}
  
  .page{display:none}
  .page.active{display:block}
  
  .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #dee2e6}
  .section-title h2{margin:0;color:var(--black);font-weight:600}
  
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden;margin-bottom:25px}
  th{background:var(--black);color:#fff;padding:15px;text-align:left;font-weight:600;font-size:14px}
  td{padding:15px;border-bottom:1px solid #dee2e6;font-size:14px}
  tr:hover{background:#f8f9fa}
  
  .actions{display:flex;gap:8px}
  .edit, .del, .view{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.3s ease}
  .edit{background:var(--blue);color:#fff}
  .edit:hover{background:#2980b9}
  .del{background:var(--red);color:#fff}
  .del:hover{background:#a93226}
  .view{background:var(--green);color:#fff}
  .view:hover{background:#229954}
  
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
  .stat-card{background:#fff;padding:25px;border-radius:12px;box-shadow:0 2px 15px rgba(0,0,0,0.1);border-left:4px solid var(--blue);transition:transform 0.3s ease}
  .stat-card:hover{transform:translateY(-2px)}
  .stat-value{font-size:32px;font-weight:700;color:var(--black);margin-bottom:5px}
  .stat-label{color:#666;font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:1px}
  
  .status-badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;text-transform:uppercase;}
  .status-pending{background:#ffeaa7;color:#e17055;}
  .status-paid{background:#55efc4;color:#00b894;}
  .status-overdue{background:#fab1a0;color:#e74c3c;}
  
  .payment-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;overflow-y:auto;}
  .payment-modal.show{display:flex;}
  .payment-content{background:#fff;padding:30px;border-radius:16px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideIn 0.3s ease;margin:20px;}
  @keyframes slideIn{from{transform:translateY(-50px);opacity:0} to{transform:translateY(0);opacity:1}}
  
  .payment-header{text-align:center;margin-bottom:30px;}
  .payment-header h2{margin:0 0 10px;color:var(--black);font-size:28px;}
  .payment-header p{margin:0;color:#666;}
  
  .payment-options{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;}
  .payment-option{border:3px solid #dee2e6;border-radius:12px;padding:25px;text-align:center;cursor:pointer;transition:all 0.3s ease;}
  .payment-option:hover{border-color:var(--blue);transform:translateY(-2px);}
  .payment-option.selected{border-color:var(--green);background:#f0fff4;}
  .payment-option .price{font-size:32px;font-weight:700;color:var(--black);margin:10px 0;}
  .payment-option .period{color:#666;font-weight:600;text-transform:uppercase;font-size:12px;}
  .payment-option .save{background:var(--green);color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;margin-top:8px;display:inline-block;}
  
  .mpesa-instructions{background:#f8f9fa;border-radius:12px;padding:25px;margin-bottom:25px;}
  .mpesa-instructions h3{margin:0 0 20px;color:var(--black);display:flex;align-items:center;gap:10px;}
  .mpesa-instructions ol{margin:10px 0;padding-left:25px;}
  .mpesa-instructions li{margin:10px 0;color:#333;line-height:1.6;}
  .mpesa-instructions .highlight{background:var(--green);color:#fff;padding:8px 12px;border-radius:6px;font-weight:700;display:inline-block;margin:5px 0;}
  
  .payment-form{background:#fff;border-radius:8px;margin-top:20px;}
  .payment-form input{width:100%;padding:12px;margin:10px 0;border:1px solid #dee2e6;border-radius:8px;font-size:14px;}
  .payment-form input:focus{outline:none;border-color:var(--blue);}
  
  .copyright-footer{position:fixed;bottom:0;right:0;background:rgba(0,0,0,0.8);color:#fff;padding:10px 15px;font-size:12px;border-radius:8px 0 0 0;z-index:1000;font-weight:500}
  
  /* Invoice Dropdown Styles */
  .invoice-dropdown{position:relative;display:inline-block;}
  .invoice-dropdown-content{display:none;position:absolute;background-color:#fff;min-width:200px;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);z-index:1000;border-radius:8px;margin-top:5px;}
  .invoice-dropdown:hover .invoice-dropdown-content{display:block;}
  .invoice-dropdown-content button{display:block;width:100%;padding:12px 16px;text-align:left;border:none;background:#fff;color:#333;cursor:pointer;font-size:14px;border-bottom:1px solid #eee;transition:background 0.3s ease;}
  .invoice-dropdown-content button:hover{background:#f8f9fa;}
  .invoice-dropdown-content button:last-child{border-bottom:none;}
  
  /* Invoice Modal Styles */
  .invoice-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;align-items:center;justify-content:center;}
  .invoice-modal.show{display:flex;}
  .invoice-content{background:#fff;padding:40px;border-radius:16px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideIn 0.3s ease;}
  @keyframes slideIn{from{transform:translateY(-50px);opacity:0} to{transform:translateY(0);opacity:1}}
  .invoice-form{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;}
  .invoice-form .full-width{grid-column:1 / -1;}
  .invoice-form label{display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#333;}
  .invoice-form input,.invoice-form select,.invoice-form textarea{width:100%;padding:12px;border:1px solid #dee2e6;border-radius:8px;font-size:14px;}
  .invoice-form input:focus,.invoice-form select:focus,.invoice-form textarea:focus{outline:none;border-color:var(--blue);}
  .invoice-total{display:flex;justify-content:space-between;align-items:center;padding:20px;background:#f8f9fa;border-radius:8px;margin:20px 0;}
  .invoice-total .total-amount{font-size:24px;font-weight:700;color:var(--green);}
  .invoice-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}
  
  @media (max-width:768px){
    .hamburger{display:flex}
    .content{flex-direction:row}
    .sidebar{
      width: 280px;
      height: calc(100vh - 60px);
      position: fixed;
      top: 60px;
      left: -280px;
      z-index: 1000;
      overflow-y: auto;
      background: linear-gradient(180deg,#2c3e50 0%,#34495e 100%);
      transition: left 0.3s ease;
    }
    .sidebar.open{
      left: 0;
    }
    #mainSection{
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #fff;
      width: 100%;
    }
    .stats-grid{grid-template-columns:1fr 1fr}
    .payment-options{grid-template-columns:1fr}
    .invoice-form{grid-template-columns:1fr}
    .nav-item{padding:12px 15px;font-size:14px}
    .logo{font-size:18px;padding:12px 15px}
    .user-info{padding:12px 15px;gap:10px}
    .section-title h2{font-size:20px}
    table{font-size:12px}
    th, td{padding:10px 8px}
    .actions{gap:5px}
    .edit, .del, .view{padding:4px 8px;font-size:11px}
  }
  
  @media (max-width:480px){
    .sidebar{
      width: 250px;
      left: -250px;
    }
    .sidebar.open{
      left: 0;
    }
    #mainSection{
      padding: 10px;
    }
    .stats-grid{grid-template-columns:1fr}
    .payment-content{
      max-width: 95%;
      padding: 20px;
      margin: 10px;
    }
    .nav-item{padding:10px 12px;font-size:13px}
    .logo{font-size:16px;padding:10px 12px}
  }
</style>
</head>

<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <div id="loginScreen">
    <div class="authCard">
      <h2>üè† RentPoa Login</h2>
      <div id="loginError" class="error"></div>
      <input type="email" id="loginEmail" placeholder="Email" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button class="btn" onclick="login()">Sign In</button>
      <p style="margin-top:20px;color:rgba(255,255,255,0.7)">
        Don't have an account? <a href="#" onclick="showSignup()" style="color:var(--blue)">Sign up</a>
      </p>
    </div>
  </div>

  <div id="signupScreen">
    <div class="authCard">
      <h2>üè† Create Account</h2>
      <div id="signupError" class="error"></div>
      <div id="signupSuccess" class="success"></div>
      <input type="text" id="signupName" placeholder="Full Name" />
      <input type="email" id="signupEmail" placeholder="Email" />
      <input type="password" id="signupPassword" placeholder="Password (min 6 chars)" />
      <p style="font-size:13px;color:rgba(255,255,255,0.8);margin:15px 0;">
        ‚ö° Start with 1 hour FREE trial<br>
        Then Ksh 3,000/month or Ksh 20,000/year
      </p>
      <button class="btn" onclick="signup()">Create Account & Start Trial</button>
      <p style="margin-top:20px;color:rgba(255,255,255,0.7)">
        Already have an account? <a href="#" onclick="showLogin()" style="color:var(--blue)">Sign in</a>
      </p>
    </div>
  </div>

  <div id="app">
    <div class="header">
      <div class="header-left">
        <button class="hamburger" onclick="toggleMobileMenu()">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="logo">üè† RentPoa</div>
      </div>
      <div class="user-info">
        <span class="subscription-badge" id="subscriptionBadge">FREE TRIAL</span>
        <span id="userName"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="trial-banner" id="trialBanner" style="display:none;">
      ‚è∞ Free Trial: <span id="trialTimer"></span> remaining
    </div>

    <div class="content">
      <div class="sidebar">
        <div class="nav-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="showSection('housetypes')">üè† House Types</div>
        <div class="nav-item" onclick="showSection('properties')">üè¢ Properties</div>
        <div class="nav-item" onclick="showSection('tenants')">üë• Tenants</div>
        <div class="nav-item" onclick="showSection('invoices')">üìÑ Invoices</div>
        <div class="nav-item" onclick="showSection('receipts')">üßæ Receipts</div>
        <div class="nav-item" onclick="showSection('payments')">üí∞ Payments</div>
      </div>

      <div id="mainSection">
        <div id="dashboard" class="page active">
          <div class="section-title">
            <h2>Dashboard</h2>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalProperties">0</div>
              <div class="stat-label">Total Properties</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalTenants">0</div>
              <div class="stat-label">Total Tenants</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="monthlyIncome">Ksh 0</div>
              <div class="stat-label">Monthly Income</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="pendingInvoices">0</div>
              <div class="stat-label">Pending Invoices</div>
            </div>
          </div>
        </div>

        <div id="housetypes" class="page">
          <div class="section-title">
            <h2>House Types</h2>
            <button class="btn" onclick="showAddHouseTypeForm()">+ Add House Type</button>
          </div>
          
          <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
            <h3 style="margin:0 0 15px;font-size:16px;color:#333;">üè¢ Property Occupancy Overview</h3>
            <div style="display:grid;grid-template-columns:1fr auto;gap:15px;align-items:end;">
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Select Property</label>
                <select id="propertyOccupancyFilter" onchange="loadPropertyOccupancy()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
                  <option value="">All Properties</option>
                </select>
              </div>
              <button class="btn orange" onclick="clearOccupancyFilter()" style="padding:10px 20px;">Show All</button>
            </div>
            <div id="occupancyStats" style="margin-top:15px;"></div>
          </div>
          
          <table id="houseTypesTable">
            <thead>
              <tr>
                <th>Type Name</th>
                <th>Rent Amount</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="properties" class="page">
          <div class="section-title">
            <h2>Properties</h2>
            <button class="btn" onclick="showAddPropertyForm()">+ Add Property</button>
          </div>
          <table id="propertiesTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Location</th>
                <th>House Type</th>
                <th>Total Houses</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="tenants" class="page">
          <div class="section-title">
            <h2>Tenants</h2>
            <div style="display:flex;gap:10px;align-items:center;">
              <button class="btn" onclick="showAddTenantForm()">+ Add Tenant</button>
            </div>
          </div>
          
          <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
            <h3 style="margin:0 0 15px;font-size:16px;color:#333;">üîç Filter Tenants</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:15px;align-items:end;">
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Property</label>
                <select id="filterProperty" onchange="filterTenants()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
                  <option value="">All Properties</option>
                </select>
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">House Type</label>
                <select id="filterHouseType" onchange="filterTenants()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
                  <option value="">All House Types</option>
                </select>
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Search Tenant</label>
                <input type="text" id="filterTenantName" onkeyup="filterTenants()" placeholder="Search by name..." style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;" />
              </div>
              <button class="btn orange" onclick="clearTenantFilters()" style="padding:10px 20px;">Clear Filters</button>
            </div>
            <div id="filterStats" style="margin-top:15px;padding:12px;background:#fff;border-radius:6px;font-size:13px;color:#666;font-weight:600;"></div>
          </div>
          
          <table id="tenantsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Property</th>
                <th>House Type</th>
                <th>House Number</th>
                <th>Rent</th>
                <th>Move-in Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="invoices" class="page">
          <div class="section-title">
            <h2>Invoices</h2>
            <div>
              <div class="invoice-dropdown">
                <button class="btn" style="background:var(--blue);">üìÑ Invoice Options ‚ñº</button>
                <div class="invoice-dropdown-content">
                  <button onclick="showCreateInvoiceModal()">‚ûï Create New Invoice</button>
                  <button onclick="generateInvoices()">üìã Generate All Invoices</button>
                  <button onclick="viewInvoices()">üëÅÔ∏è View All Invoices</button>
                  <button onclick="exportInvoicesData()">üì§ Export All Data</button>
                </div>
              </div>
            </div>
          </div>
          
          <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
            <h3 style="margin:0 0 15px;font-size:16px;color:#333;">üìã Generate Invoice for Specific Tenant</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:15px;align-items:end;">
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Property</label>
                <select id="invoiceFilterProperty" onchange="updateInvoiceHouseTypes()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
                  <option value="">Select Property</option>
                </select>
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">House Type</label>
                <select id="invoiceFilterHouseType" onchange="updateInvoiceTenants()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
                  <option value="">Select House Type</option>
                </select>
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Tenant</label>
                <select id="invoiceFilterTenant" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
                  <option value="">Select Tenant</option>
                </select>
              </div>
              <button class="btn" onclick="generateSingleInvoice()" style="padding:10px 20px;">Generate Invoice</button>
              <button class="btn green" onclick="exportSingleInvoicePDF()" style="padding:10px 20px;">Export PDF</button>
            </div>
            <div id="invoiceFilterInfo" style="margin-top:15px;padding:12px;background:#fff;border-radius:6px;font-size:13px;color:#666;font-weight:600;"></div>
          </div>
          
          <div style="background:linear-gradient(135deg,#e3f2fd,#bbdefb);padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid var(--blue);">
            <h4 style="margin:0 0 8px;color:#1565c0;font-size:15px;">üÜï Enhanced Invoice Features:</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;font-size:13px;color:#1976d2;">
              <div>‚Ä¢ <strong>üìÑ Invoice Options</strong> dropdown for advanced features</div>
              <div>‚Ä¢ <strong>‚ûï Create New Invoice</strong> with custom bill entries</div>
              <div>‚Ä¢ <strong>üíß Water, ‚ö° Electricity, üóëÔ∏è Waste, üîß Service fees</strong></div>
              <div>‚Ä¢ <strong>üìß Email invoices</strong> directly to tenants</div>
              <div>‚Ä¢ <strong>üëÅÔ∏è PDF preview</strong> before generating</div>
              <div>‚Ä¢ <strong>‚ú® Custom invoices</strong> marked with special indicator</div>
            </div>
          </div>
          
          <table id="invoicesTable">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Tenant</th>
                <th>House</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="payments" class="page">
          <div class="section-title">
            <h2>Payments</h2>
            <div>
              <button class="btn" onclick="showRecordPaymentForm()">+ Record Payment</button>
              <button class="btn green" onclick="exportPaymentsData()">Export Data</button>
            </div>
          </div>
          <table id="paymentsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Tenant</th>
                <th>House</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Reference</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="receipts" class="page">
          <div class="section-title">
            <h2>üßæ Receipts</h2>
            <div>
              <button class="btn green" onclick="exportReceiptsData()">üìä Export Receipts</button>
              <button class="btn orange" onclick="generateReceiptPDF()">üßæ Generate PDF</button>
            </div>
          </div>
          
          <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
            <h3 style="margin:0 0 15px;font-size:16px;color:#333;">üîç Filter Receipts</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;align-items:end;">
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Filter by Property</label>
                <select id="receiptPropertyFilter" onchange="onPropertyFilterChange()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
                  <option value="">All Properties</option>
                </select>
              </div>
              <div>
                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;color:#666;">Filter by Tenant</label>
                <select id="receiptTenantFilter" onchange="filterReceipts()" style="width:100%;padding:10px;border:1px solid #dee2e6;border-radius:6px;font-size:14px;">
                  <option value="">All Tenants</option>
                </select>
              </div>
              <button class="btn orange" onclick="clearReceiptFilters()" style="padding:10px 20px;">Show All Receipts</button>
            </div>
            <div id="receiptStats" style="margin-top:15px;font-weight:600;color:#666;"></div>
          </div>
          
          <table id="receiptsTable">
            <thead>
              <tr>
                <th>Receipt #</th>
                <th>Tenant</th>
                <th>Phone</th>
                <th>Property</th>
                <th>House</th>
                <th>Amount</th>
                <th>Paid Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="payment-modal" id="paymentModal">
    <div class="payment-content">
      <div class="payment-header">
        <h2>üí≥ Activate Your Subscription</h2>
        <p>Choose your plan and complete payment via M-Pesa</p>
      </div>

      <div class="payment-options">
        <div class="payment-option" onclick="selectPlan('monthly')" id="monthlyPlan">
          <div class="period">Monthly</div>
          <div class="price">Ksh 3,000</div>
          <small style="color:#666;">Billed monthly</small>
        </div>
        <div class="payment-option" onclick="selectPlan('yearly')" id="yearlyPlan">
          <div class="period">Yearly</div>
          <div class="price">Ksh 20,000</div>
          <div class="save">SAVE Ksh 16,000!</div>
          <small style="color:#666;">Billed annually</small>
        </div>
      </div>

      <div class="mpesa-instructions">
        <h3>üì± M-Pesa Payment Instructions</h3>
        <ol>
          <li>Go to <strong>M-Pesa Menu</strong> on your phone</li>
          <li>Select <strong>Send Money</strong></li>
          <li>Enter Phone Number: <span class="highlight">0715595646</span></li>
          <li>Enter Amount: <span class="highlight" id="selectedAmount">Ksh 3,000</span></li>
          <li>Confirm recipient name: <span class="highlight">DAISY SIMIYU</span></li>
          <li>Enter your M-Pesa PIN and send</li>
          <li>You will receive a confirmation SMS with transaction ID</li>
          <li>Enter the transaction details below to activate</li>
        </ol>
      </div>

      <div class="payment-form">
        <input type="text" id="mpesaPhone" placeholder="Your M-Pesa Phone Number (e.g., 0712345678)" required />
        <input type="text" id="mpesaTransactionId" placeholder="M-Pesa Transaction ID (e.g., QH12ABC456)" required />
        <input type="text" id="mpesaConfirmName" placeholder="Confirmation Name (should be DAISY SIMIYU)" value="DAISY SIMIYU" required />
        
        <button class="btn green" onclick="submitPayment()" style="width:100%;margin-top:10px;">
          ‚úî Confirm Payment & Activate
        </button>
      </div>

      <p style="text-align:center;margin-top:20px;color:#666;font-size:13px;">
        üîí Your payment will be verified and subscription activated within minutes.
      </p>
    </div>
  </div>

  <!-- Invoice Creation Modal -->
  <div class="invoice-modal" id="invoiceModal">
    <div class="invoice-content">
      <div style="text-align:center;margin-bottom:30px;">
        <h2 style="margin:0 0 10px;color:var(--black);font-size:28px;">üìÑ Create New Invoice</h2>
        <p style="margin:0;color:#666;">Generate a detailed invoice with custom bill entries</p>
      </div>

      <div class="invoice-form">
        <div class="full-width">
          <label>Select Tenant *</label>
          <select id="invoiceTenant" onchange="loadTenantInfo()" required>
            <option value="">Choose a tenant...</option>
          </select>
        </div>
        
        <div>
          <label>Property</label>
          <input type="text" id="invoiceProperty" readonly />
        </div>
        
        <div>
          <label>House Number</label>
          <input type="text" id="invoiceHouseNumber" readonly />
        </div>
        
        <div>
          <label>Monthly Rent (Ksh) *</label>
          <input type="number" id="invoiceRent" min="0" step="0.01" readonly />
        </div>
        
        <div>
          <label>Invoice Period *</label>
          <input type="text" id="invoicePeriod" placeholder="e.g., January 2025" required />
        </div>
        
        <div>
          <label>Due Date *</label>
          <input type="date" id="invoiceDueDate" required />
        </div>
        
        <div>
          <label>Water Bill (Ksh)</label>
          <input type="number" id="invoiceWaterBill" min="0" step="0.01" value="0" onchange="updateInvoiceTotal()" />
        </div>
        
        <div>
          <label>Electricity (Ksh)</label>
          <input type="number" id="invoiceElectricity" min="0" step="0.01" value="0" onchange="updateInvoiceTotal()" />
        </div>
        
        <div>
          <label>Waste Management (Ksh)</label>
          <input type="number" id="invoiceWasteManagement" min="0" step="0.01" value="0" onchange="updateInvoiceTotal()" />
        </div>
        
        <div>
          <label>Service Fee (Ksh)</label>
          <input type="number" id="invoiceServiceFee" min="0" step="0.01" value="0" onchange="updateInvoiceTotal()" />
        </div>
        
        <div class="full-width">
          <label>Additional Notes</label>
          <textarea id="invoiceNotes" placeholder="Optional notes or additional information..."></textarea>
        </div>
      </div>
      
      <div class="invoice-total">
        <div>
          <strong>Total Amount:</strong><br>
          <small style="color:#666;">Rent + All Bills</small>
        </div>
        <div class="total-amount" id="invoiceTotal">Ksh 0</div>
      </div>
      
      <div class="invoice-actions">
        <button class="btn" onclick="hideCreateInvoiceModal()">Cancel</button>
        <button class="btn orange" onclick="previewInvoicePDF()">üëÅÔ∏è Preview PDF</button>
        <button class="btn green" onclick="generateCustomInvoice()">‚úì Generate Invoice</button>
      </div>
    </div>
  </div>

  <div class="copyright-footer">
    CHARLES SOFTWARE2025
  </div>

<script>
const SUPABASE_URL = 'https://ozczypkobtrocdeyujvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96Y3p5cGtvYnRyb2NkZXl1anZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2OTg0MjgsImV4cCI6MjA3NjI3NDQyOH0.EFa_7KzbAxxg5Oc5JoOX6q9Jf6BQ0sZAfQEWlKTQJVo';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let userSubscription = null;
let selectedPaymentPlan = 'monthly';
let trialCheckInterval = null;

function showLoading() {
  document.getElementById('loadingOverlay').classList.add('show');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('show');
}

function showError(elementId, message) {
  const errorElement = document.getElementById(elementId);
  errorElement.textContent = message;
  errorElement.style.display = 'block';
  setTimeout(() => errorElement.style.display = 'none', 5000);
}

function showSuccess(elementId, message) {
  const successElement = document.getElementById(elementId);
  successElement.textContent = message;
  successElement.style.display = 'block';
  setTimeout(() => successElement.style.display = 'none', 5000);
}

async function login() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  
  if (!email || !password) {
    showError('loginError', 'Please fill in all fields');
    return;
  }
  
  try {
    showLoading();
    const { data, error } = await supabase.auth.signInWithPassword({email, password});
    if (error) throw error;
  } catch (error) {
    showError('loginError', error.message);
  } finally {
    hideLoading();
  }
}

async function signup() {
  const name = document.getElementById('signupName').value;
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  
  if (!name || !email || !password) {
    showError('signupError', 'Please fill in all fields');
    return;
  }
  
  if (password.length < 6) {
    showError('signupError', 'Password must be at least 6 characters');
    return;
  }
  
  try {
    showLoading();
    const { data, error } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {data: {name: name}}
    });
    
    if (error) throw error;
    showSuccess('signupSuccess', 'Account created! Check your email for verification.');
    
  } catch (error) {
    showError('signupError', error.message);
  } finally {
    hideLoading();
  }
}

async function logout() {
  try {
    if (trialCheckInterval) clearInterval(trialCheckInterval);
    await supabase.auth.signOut();
  } catch (error) {
    console.error('Logout error:', error);
  }
}

function showLogin() {
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('signupScreen').style.display = 'none';
}

function showSignup() {
  document.getElementById('signupScreen').style.display = 'flex';
  document.getElementById('loginScreen').style.display = 'none';
}

async function checkSubscription() {
  try {
    console.log('üîç Checking subscription for user:', currentUser?.id);
    
    // First, check database for existing subscription
    const { data: subscription, error } = await supabase
      .from('subscriptions')
      .select('*')
      .eq('user_id', currentUser.id)
      .single();
    
    if (error) {
      console.warn('No subscription found in database:', error.message);
    }
    
    if (subscription) {
      console.log('üìä Found subscription in database:', subscription);
      
      // Check if this is an owner subscription
      if (subscription.subscription_type === 'owner') {
        console.log('üèÜ OWNER MODE: Detected owner subscription from database');
        
        userSubscription = {
          subscription_status: subscription.subscription_status || 'active',
          subscription_type: 'owner',
          subscription_expires_at: subscription.subscription_expires_at || new Date(2030, 0, 1).toISOString(),
          payment_verified: true
        };
        
        updateSubscriptionUI();
        return;
      }
      
      // Check if trial has expired
      if (subscription.subscription_type === 'trial') {
        const now = new Date();
        const trialExpires = new Date(subscription.trial_expires_at);
        
        if (trialExpires <= now) {
          console.log('‚è∞ Trial has expired - blocking access and showing payment modal');
          
          // Trial expired - block access and show payment modal
          userSubscription = {
            subscription_status: 'expired',
            subscription_type: 'trial',
            trial_expires_at: subscription.trial_expires_at,
            created_at: subscription.created_at
          };
          
          updateSubscriptionUI();
          showPaymentModal(); // Show payment modal immediately
          return; // Don't allow dashboard access
        }
        
        // Trial is still active
        userSubscription = subscription;
        updateSubscriptionUI();
        return;
      }
      
      // Regular subscription found
      userSubscription = subscription;
      updateSubscriptionUI();
      return;
    }
    
    // No subscription found - create trial subscription
    console.log('‚ö†Ô∏è No subscription found, creating trial...');
    await createTrialSubscription();
    
  } catch (error) {
    console.error('Error checking subscription:', error);
    
    // OWNER ACCESS - Always give unlimited access as fallback
    console.log('üèÜ OWNER MODE: Fallback - unlimited access granted due to error');
    
    userSubscription = {
      subscription_status: 'active',
      subscription_type: 'owner',
      subscription_expires_at: new Date(2030, 0, 1).toISOString(),
      payment_verified: true
    };
    
    updateSubscriptionUI();
  }
}

async function createTrialSubscription() {
  try {
    console.log('üìù Creating trial subscription for user:', currentUser?.id);
    
    // Don't create trial for owners - they have unlimited access
    if (currentUser?.email) {
      const ownerEmails = [
        'admin@rentpoa.com',
        'owner@rentpoa.com', 
        'charlessoftware2025@gmail.com',
        'daisy@rentpoa.com',
        'charlesogutu081@gmail.com'
      ];
      
      if (ownerEmails.includes(currentUser.email.toLowerCase())) {
        console.log('üèÜ OWNER DETECTED: Skipping trial creation for owner');
        return;
      }
    }
    
    // Check if this should be an owner subscription
    const { data: existingSub, error: subError } = await supabase
      .from('subscriptions')
      .select('*')
      .eq('user_id', currentUser.id)
      .single();
    
    if (subError && subError.code !== 'PGRST116') {
      console.error('Error checking existing subscription:', subError);
    }
    
    // If owner subscription exists, use that instead of trial
    if (existingSub && existingSub.subscription_type === 'owner') {
      console.log('üèÜ OWNER MODE: Owner subscription found, skipping trial creation');
      
      userSubscription = {
        subscription_status: existingSub.subscription_status || 'active',
        subscription_type: 'owner',
        subscription_expires_at: existingSub.subscription_expires_at || new Date(2030, 0, 1).toISOString(),
        payment_verified: true
      };
      
      updateSubscriptionUI();
      return;
    }
    
    // Create regular trial subscription
    console.log('‚è∞ Creating 1-hour trial subscription');
    
    const trialDuration = 1 * 60 * 60 * 1000; // 1 hour in milliseconds
    const now = new Date();
    const expiresAt = new Date(now.getTime() + trialDuration);
    
    // Save trial to database for persistence
    const { data: trialData, error: trialError } = await supabase
      .from('subscriptions')
      .insert({
        user_id: currentUser.id,
        subscription_status: 'trial',
        subscription_type: 'trial',
        trial_expires_at: expiresAt.toISOString(),
        created_at: now.toISOString()
      })
      .select()
      .single();
    
    if (trialError) {
      console.error('Error saving trial to database:', trialError);
      // Continue with local trial even if database save fails
    } else {
      console.log('‚úÖ Trial saved to database successfully');
    }
    
    userSubscription = {
      subscription_status: 'trial',
      subscription_type: 'trial',
      trial_expires_at: expiresAt.toISOString(),
      created_at: now.toISOString()
    };
    
    updateSubscriptionUI();
    startTrialTimer();
    
    console.log('‚úÖ Trial subscription created - expires:', expiresAt.toISOString());
    
  } catch (error) {
    console.error('Error creating subscription:', error);
    
    // OWNER ACCESS - Fallback to owner mode
    console.log('üèÜ OWNER MODE: Fallback - giving permanent access due to error');
    
    userSubscription = {
      subscription_status: 'active',
      subscription_type: 'owner',
      subscription_expires_at: new Date(2030, 0, 1).toISOString(),
      payment_verified: true
    };
    
    updateSubscriptionUI();
  }
}

function startTrialTimer() {
  // OWNER MODE: Skip trial timer - no payment required
  if (userSubscription && userSubscription.subscription_status === 'active' && userSubscription.subscription_type === 'owner') {
    console.log('üèÜ OWNER MODE: Trial timer skipped - unlimited access');
    return;
  }
  
  // Skip timer if trial is expired
  if (userSubscription && userSubscription.subscription_status === 'expired') {
    console.log('‚è∞ Trial already expired - skipping timer');
    return;
  }
  
  if (trialCheckInterval) clearInterval(trialCheckInterval);
  
  trialCheckInterval = setInterval(async () => {
    if (!userSubscription || userSubscription.subscription_status !== 'trial') {
      clearInterval(trialCheckInterval);
      return;
    }
    
    const now = new Date();
    const trialExpires = new Date(userSubscription.trial_expires_at);
    const timeLeft = trialExpires - now;
    
    if (timeLeft <= 0) {
      clearInterval(trialCheckInterval);
      
      // Update database to mark trial as expired
      try {
        await supabase
          .from('subscriptions')
          .update({ 
            subscription_status: 'expired',
            updated_at: new Date().toISOString()
          })
          .eq('user_id', currentUser.id)
          .eq('subscription_type', 'trial');
          
        console.log('‚è∞ Trial marked as expired in database');
      } catch (error) {
        console.error('Error updating trial status in database:', error);
      }
      
      // Update local subscription status
      userSubscription.subscription_status = 'expired';
      updateSubscriptionUI();
      
      showPaymentModal();
      return;
    }
    
    const minutes = Math.floor(timeLeft / 60000);
    const seconds = Math.floor((timeLeft % 60000) / 1000);
    
    document.getElementById('trialTimer').textContent = `${minutes}m ${seconds}s`;
    document.getElementById('trialBanner').style.display = 'block';
  }, 1000);
}

function updateSubscriptionUI() {
  const badge = document.getElementById('subscriptionBadge');
  
  // Enhanced DEBUG: Log detailed subscription data
  console.log('üîç updateSubscriptionUI called');
  console.log('üìä Complete userSubscription object:', JSON.stringify(userSubscription, null, 2));
  console.log('üìã subscription_type:', userSubscription?.subscription_type);
  console.log('üìã subscription_status:', userSubscription?.subscription_status);
  console.log('üìã subscription_expires_at:', userSubscription?.subscription_expires_at);
  console.log('üìã payment_verified:', userSubscription?.payment_verified);
  console.log('üìã Current user ID:', currentUser?.id);
  
  if (!userSubscription) {
    console.log('‚ùå No userSubscription found - early return');
    return;
  }
  
  // OWNER MODE: Always show OWNER status with enhanced logging
  if (userSubscription.subscription_type === 'owner') {
    console.log('üèÜ OWNER MODE DETECTED! üéâ');
    console.log('üèÜ Setting OWNER badge with purple styling');
    console.log('üèÜ Hiding trial banner');
    console.log('üèÜ Owner expires at:', userSubscription.subscription_expires_at);
    
    badge.textContent = 'OWNER';
    badge.className = 'subscription-badge owner';
    document.getElementById('trialBanner').style.display = 'none';
    
    // Show welcome message for owner
    setTimeout(() => {
      if (confirm('üèÜ Welcome Owner! \n\nYou have unlimited access to your RentPoa app!\n\nWould you like to hide future subscription messages?')) {
        console.log('üèÜ OWNER MODE: Subscription messages disabled by user');
        localStorage.setItem('ownerMessageShown', 'true');
      }
    }, 2000);
    
    console.log('üèÜ OWNER MODE: UI successfully updated - showing OWNER status');
    return;
  }
  
  console.log('‚ö†Ô∏è NOT OWNER MODE - falling through to other logic');
  console.log('‚ö†Ô∏è Current badge will be:', userSubscription.subscription_type, userSubscription.subscription_status);
  
  if (userSubscription.subscription_status === 'trial') {
    badge.textContent = 'FREE TRIAL';
    badge.className = 'subscription-badge trial';
    console.log('üìã Set badge to: FREE TRIAL');
  } else if (userSubscription.subscription_status === 'active') {
    badge.textContent = userSubscription.subscription_type === 'monthly' ? 'MONTHLY' : 'YEARLY';
    badge.className = 'subscription-badge';
    document.getElementById('trialBanner').style.display = 'none';
    console.log('üìã Set badge to:', badge.textContent);
  } else {
    badge.textContent = 'EXPIRED';
    badge.className = 'subscription-badge expired';
    console.log('üìã Set badge to: EXPIRED');
  }
  
  console.log('‚úÖ updateSubscriptionUI completed successfully');
}

function showPaymentModal(reason = 'trial_expired') {
  // OWNER MODE: Skip payment modal - always free access
  if (userSubscription && userSubscription.subscription_type === 'owner') {
    console.log('üèÜ OWNER MODE: Payment modal skipped - unlimited free access');
    
    // Check if owner has disabled subscription messages
    if (localStorage.getItem('ownerMessageShown') === 'true') {
      return; // Silently skip
    }
    
    // Show owner welcome message
    alert('üèÜ OWNER MODE: Payment modal disabled - unlimited free access granted!');
    return;
  }
  
  // Update modal content based on reason
  const modalTitle = document.getElementById('paymentModal').querySelector('h2');
  const modalMessage = document.getElementById('paymentModal').querySelector('p');
  
  if (reason === 'trial_expired') {
    if (modalTitle) modalTitle.textContent = '‚è∞ Trial Expired';
    if (modalMessage) modalMessage.textContent = 'Your free trial has ended. Please subscribe to continue using RentPoa.';
  } else {
    if (modalTitle) modalTitle.textContent = 'üí≥ Subscribe to Continue';
    if (modalMessage) modalMessage.textContent = 'Subscribe to unlock all features of RentPoa Property Management.';
  }
  
  // Show modal and block dashboard access
  document.getElementById('paymentModal').classList.add('show');
  selectPlan('monthly');
  
  // Ensure dashboard content is hidden
  document.querySelector('.content').style.display = 'none';
  document.getElementById('trialBanner').style.display = 'none';
  
  console.log('üîí Payment modal shown - dashboard access blocked');
}

function selectPlan(plan) {
  selectedPaymentPlan = plan;
  
  document.getElementById('monthlyPlan').classList.remove('selected');
  document.getElementById('yearlyPlan').classList.remove('selected');
  
  if (plan === 'monthly') {
    document.getElementById('monthlyPlan').classList.add('selected');
    document.getElementById('selectedAmount').textContent = 'Ksh 3,000';
  } else {
    document.getElementById('yearlyPlan').classList.add('selected');
    document.getElementById('selectedAmount').textContent = 'Ksh 20,000';
  }
}

async function submitPayment() {
  const phone = document.getElementById('mpesaPhone').value;
  const transactionId = document.getElementById('mpesaTransactionId').value;
  const confirmName = document.getElementById('mpesaConfirmName').value;
  
  if (!phone || !transactionId || !confirmName) {
    alert('Please fill in all payment details');
    return;
  }
  
  if (confirmName.toUpperCase() !== 'DAISY SIMIYU') {
    alert('Confirmation name must be DAISY SIMIYU');
    return;
  }
  
  try {
    showLoading();
    
    const amount = selectedPaymentPlan === 'monthly' ? 3000 : 20000;
    const now = new Date();
    const expiresAt = new Date();
    
    if (selectedPaymentPlan === 'monthly') {
      expiresAt.setMonth(expiresAt.getMonth() + 1);
    } else {
      expiresAt.setFullYear(expiresAt.getFullYear() + 1);
    }
    
    // Create update data with only essential fields first
    const updateData = {
      subscription_status: 'active'
    };
    
    // Try to add optional subscription fields (may not exist in database)
    try {
      updateData.subscription_type = selectedPaymentPlan;
      updateData.subscription_expires_at = expiresAt.toISOString();
      updateData.mpesa_phone = phone;
      updateData.mpesa_transaction_id = transactionId;
      updateData.mpesa_confirmation_name = confirmName;
      updateData.amount_paid = amount;
      updateData.payment_verified = true;
      updateData.payment_date = now.toISOString();
    } catch (colError) {
      console.warn('Some subscription payment columns may not exist:', colError);
    }
    
    const { error } = await supabase
      .from('subscriptions')
      .update(updateData)
      .eq('user_id', currentUser.id);
    
    if (error) {
      console.warn('Could not update subscription payment info:', error);
      // Continue anyway - payment was successful
    }
    
    document.getElementById('paymentModal').classList.remove('show');
    alert('‚úÖ Payment confirmed! Your subscription is now active.');
    
    // Restore dashboard access after successful payment
    document.querySelector('.content').style.display = 'flex';
    document.getElementById('trialBanner').style.display = 'none';
    
    await checkSubscription();
    
  } catch (error) {
    console.error('Error submitting payment:', error);
    alert('Error processing payment: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function updateSubscriptionStatus(status) {
  try {
    // Try to update subscription_status (may not exist in older databases)
    const { error } = await supabase
      .from('subscriptions')
      .update({subscription_status: status})
      .eq('user_id', currentUser.id);
    
    if (error) {
      console.warn('Could not update subscription status:', error);
    }
    
  } catch (error) {
    console.warn('Error updating subscription status:', error);
    // Continue execution - this is not critical
  }
}

// Helper function to check if current user has owner access
function isOwner() {
  return userSubscription && userSubscription.subscription_type === 'owner';
}

function showSection(sectionName) {
  // Check if user can access dashboard (payment required)
  if (!userSubscription || userSubscription.subscription_status === 'expired') {
    console.log('‚õî Navigation blocked - payment required');
    showPaymentModal();
    return;
  }
  
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  
  document.getElementById(sectionName).classList.add('active');
  event.target.classList.add('active');
  
  // Close mobile menu when a nav item is clicked
  const sidebar = document.querySelector('.sidebar');
  const hamburger = document.querySelector('.hamburger');
  if (window.innerWidth <= 768) {
    sidebar.classList.remove('open');
    hamburger.classList.remove('open');
  }
  
  if (sectionName === 'dashboard') loadDashboard();
  else if (sectionName === 'housetypes') loadHouseTypes();
  else if (sectionName === 'properties') loadProperties();
  else if (sectionName === 'tenants') loadTenants();
  else if (sectionName === 'invoices') loadInvoices();
  else if (sectionName === 'receipts') loadReceipts();
  else if (sectionName === 'payments') loadPayments();
}

function toggleMobileMenu() {
  const sidebar = document.querySelector('.sidebar');
  const hamburger = document.querySelector('.hamburger');
  
  sidebar.classList.toggle('open');
  hamburger.classList.toggle('open');
}

// Handle window resize to ensure proper mobile menu behavior
window.addEventListener('resize', function() {
  const sidebar = document.querySelector('.sidebar');
  const hamburger = document.querySelector('.hamburger');
  
  if (window.innerWidth > 768) {
    sidebar.classList.remove('open');
    hamburger.classList.remove('open');
  }
});

async function loadDashboard() {
  try {
    showLoading();
    const { data: properties } = await supabase.from('properties').select('*').eq('user_id', currentUser.id);
    const { data: tenants } = await supabase.from('tenants').select('*').eq('user_id', currentUser.id);
    const { data: pendingInv } = await supabase.from('invoices').select('*').eq('user_id', currentUser.id).eq('status', 'Pending');
    
    const monthlyIncome = tenants?.reduce((sum, t) => sum + parseFloat(t.rent || 0), 0) || 0;
    
    document.getElementById('totalProperties').textContent = properties?.length || 0;
    document.getElementById('totalTenants').textContent = tenants?.length || 0;
    document.getElementById('monthlyIncome').textContent = `Ksh ${monthlyIncome.toLocaleString()}`;
    document.getElementById('pendingInvoices').textContent = pendingInv?.length || 0;
  } catch (error) {
    console.error('Error:', error);
  } finally {
    hideLoading();
  }
}

let propertyOccupancyData = [];

async function loadHouseTypes() {
  try {
    showLoading();
    await populatePropertyOccupancyDropdown();
    const { data, error } = await supabase.from('house_types').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
    if (error) throw error;
    
    const tbody = document.querySelector('#houseTypesTable tbody');
    tbody.innerHTML = '';
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #666;">No house types found. Click "+ Add House Type" to get started.<br><small>Examples: 1 Bedroom, 2 Bedroom, Studio, Bedsitter</small></td></tr>';
      return;
    }
    
    data.forEach(ht => {
      tbody.innerHTML += `<tr><td><strong>${ht.type_name}</strong></td><td><strong style="color: var(--green);">Ksh ${Number(ht.rent_amount).toLocaleString()}</strong></td><td>${ht.description || 'N/A'}</td><td class="actions"><button class="edit" onclick="editHouseType('${ht.id}')">Edit</button><button class="del" onclick="deleteHouseType('${ht.id}')">Delete</button></td></tr>`;
    });
  } catch (error) {
    alert('Error loading house types: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function populatePropertyOccupancyDropdown() {
  try {
    const { data: properties } = await supabase.from('properties').select('id, name, houses, house_type_id, house_types(type_name)').eq('user_id', currentUser.id).order('name');
    
    const propertySelect = document.getElementById('propertyOccupancyFilter');
    propertySelect.innerHTML = '<option value="">All Properties</option>';
    
    if (properties) {
      properties.forEach(prop => {
        const houseType = prop.house_types?.type_name || 'N/A';
        propertySelect.innerHTML += `<option value="${prop.id}">${prop.name} - ${houseType} (${prop.houses} units)</option>`;
      });
    }
  } catch (error) {
    console.error('Error loading properties:', error);
  }
}

async function loadPropertyOccupancy() {
  const propertyId = document.getElementById('propertyOccupancyFilter').value;
  
  try {
    showLoading();
    
    let propertiesQuery = supabase
      .from('properties')
      .select('id, name, houses, location, house_type_id, house_types(type_name, rent_amount)')
      .eq('user_id', currentUser.id);
    
    if (propertyId) {
      propertiesQuery = propertiesQuery.eq('id', propertyId);
    }
    
    const { data: properties, error: propError } = await propertiesQuery;
    if (propError) throw propError;
    
    const { data: tenants, error: tenantError } = await supabase
      .from('tenants')
      .select('property_id, house_number')
      .eq('user_id', currentUser.id);
    if (tenantError) throw tenantError;
    
    const occupancyHtml = properties.map(property => {
      const occupiedHouses = tenants.filter(t => t.property_id === property.id);
      const occupiedCount = occupiedHouses.length;
      const vacantCount = property.houses - occupiedCount;
      const occupancyRate = property.houses > 0 ? ((occupiedCount / property.houses) * 100).toFixed(1) : 0;
      
      const houseTypeName = property.house_types?.type_name || 'N/A';
      const rentAmount = property.house_types?.rent_amount || 0;
      
      const occupiedHouseNumbers = occupiedHouses.map(t => t.house_number).sort();
      const allHouseNumbers = Array.from({length: property.houses}, (_, i) => `${i + 1}`);
      const vacantHouseNumbers = allHouseNumbers.filter(num => !occupiedHouseNumbers.includes(num));
      
      return `
        <div style="background:#fff;border-radius:8px;padding:20px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px;">
            <div>
              <h4 style="margin:0 0 5px;font-size:18px;color:#333;">üè¢ ${property.name}</h4>
              <p style="margin:0;color:#666;font-size:13px;">üìç ${property.location} | üè† ${houseTypeName} | üí∞ Ksh ${Number(rentAmount).toLocaleString()}/month</p>
            </div>
            <div style="text-align:right;">
              <div style="font-size:24px;font-weight:700;color:${occupancyRate >= 80 ? 'var(--green)' : occupancyRate >= 50 ? 'var(--orange)' : 'var(--red)'}">${occupancyRate}%</div>
              <div style="font-size:11px;color:#666;text-transform:uppercase;">Occupancy</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:15px;">
            <div style="background:#f8f9fa;padding:15px;border-radius:6px;text-align:center;">
              <div style="font-size:28px;font-weight:700;color:#333;">${property.houses}</div>
              <div style="font-size:12px;color:#666;font-weight:600;">TOTAL UNITS</div>
            </div>
            <div style="background:#d5f4e6;padding:15px;border-radius:6px;text-align:center;">
              <div style="font-size:28px;font-weight:700;color:var(--green);">${occupiedCount}</div>
              <div style="font-size:12px;color:#666;font-weight:600;">OCCUPIED</div>
            </div>
            <div style="background:#ffe5e5;padding:15px;border-radius:6px;text-align:center;">
              <div style="font-size:28px;font-weight:700;color:var(--red);">${vacantCount}</div>
              <div style="font-size:12px;color:#666;font-weight:600;">VACANT</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <div style="font-weight:600;margin-bottom:8px;color:#333;font-size:13px;">‚úÖ OCCUPIED UNITS:</div>
              <div style="display:flex;flex-wrap:wrap;gap:6px;">
                ${occupiedHouseNumbers.length > 0 ? occupiedHouseNumbers.map(num => 
                  `<span style="background:var(--green);color:#fff;padding:4px 10px;border-radius:4px;font-size:12px;font-weight:600;">House ${num}</span>`
                ).join('') : '<span style="color:#999;font-size:12px;">None</span>'}
              </div>
            </div>
            <div>
              <div style="font-weight:600;margin-bottom:8px;color:#333;font-size:13px;">üîì VACANT UNITS:</div>
              <div style="display:flex;flex-wrap:wrap;gap:6px;">
                ${vacantHouseNumbers.length > 0 ? vacantHouseNumbers.map(num => 
                  `<span onclick="addTenantFromVacantUnit('${property.id}', '${num}')" style="background:var(--red);color:#fff;padding:4px 10px;border-radius:4px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none';">House ${num}</span>`
                ).join('') : '<span style="color:#999;font-size:12px;">None</span>'}
              </div>
            </div>
          </div>
          
          <div style="margin-top:15px;padding-top:15px;border-top:1px solid #dee2e6;">
            <div style="font-size:13px;color:#666;">
              üíµ <strong>Monthly Income:</strong> Ksh ${(occupiedCount * Number(rentAmount)).toLocaleString()} | 
              üí∏ <strong>Potential Income (if full):</strong> Ksh ${(property.houses * Number(rentAmount)).toLocaleString()}
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    const statsDiv = document.getElementById('occupancyStats');
    if (properties.length === 0) {
      statsDiv.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">No properties found. Add properties first!</div>';
    } else {
      const totalUnits = properties.reduce((sum, p) => sum + p.houses, 0);
      const totalOccupied = properties.reduce((sum, p) => {
        return sum + tenants.filter(t => t.property_id === p.id).length;
      }, 0);
      const totalVacant = totalUnits - totalOccupied;
      const overallRate = totalUnits > 0 ? ((totalOccupied / totalUnits) * 100).toFixed(1) : 0;
      
      statsDiv.innerHTML = `
        <div style="background:#fff;padding:15px;border-radius:6px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;">
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:700;color:#333;">${properties.length}</div>
              <div style="font-size:11px;color:#666;font-weight:600;">PROPERTIES</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:700;color:#333;">${totalUnits}</div>
              <div style="font-size:11px;color:#666;font-weight:600;">TOTAL UNITS</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:700;color:var(--green);">${totalOccupied}</div>
              <div style="font-size:11px;color:#666;font-weight:600;">OCCUPIED</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:700;color:var(--red);">${totalVacant}</div>
              <div style="font-size:11px;color:#666;font-weight:600;">VACANT</div>
            </div>
          </div>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid #dee2e6;text-align:center;">
            <span style="font-size:13px;color:#666;font-weight:600;">Overall Occupancy Rate: </span>
            <span style="font-size:18px;font-weight:700;color:${overallRate >= 80 ? 'var(--green)' : overallRate >= 50 ? 'var(--orange)' : 'var(--red)'}">${overallRate}%</span>
          </div>
        </div>
        ${occupancyHtml}
      `;
    }
    
  } catch (error) {
    console.error('Error loading occupancy:', error);
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

function clearOccupancyFilter() {
  document.getElementById('propertyOccupancyFilter').value = '';
  loadPropertyOccupancy();
}

function addTenantFromVacantUnit(propertyId, houseNumber) {
  showSection('tenants');
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  document.querySelectorAll('.nav-item')[3].classList.add('active');
  
  setTimeout(() => {
    showAddTenantForm(propertyId, houseNumber);
  }, 100);
}

function showAddHouseTypeForm() {
  const typeName = prompt('House Type Name:\n(e.g., "1 Bedroom", "2 Bedroom", "Studio", "Bedsitter")');
  if (!typeName) return;
  const rentAmount = prompt('Monthly Rent Amount (Ksh):');
  if (!rentAmount) return;
  const description = prompt('Description (optional):\n(e.g., "Spacious with balcony")');
  addHouseType(typeName, parseFloat(rentAmount), description);
}

async function addHouseType(typeName, rentAmount, description) {
  try {
    showLoading();
    const { error } = await supabase.from('house_types').insert([{type_name: typeName, rent_amount: rentAmount, description: description || null, user_id: currentUser.id}]);
    if (error) throw error;
    alert('House type added successfully!');
    loadHouseTypes();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function editHouseType(id) {
  try {
    showLoading();
    const { data, error } = await supabase.from('house_types').select('*').eq('id', id).eq('user_id', currentUser.id).single();
    if (error) throw error;
    hideLoading();
    
    const typeName = prompt('House Type Name:', data.type_name);
    if (!typeName) return;
    const rentAmount = prompt('Monthly Rent Amount (Ksh):', data.rent_amount);
    if (!rentAmount) return;
    const description = prompt('Description (optional):', data.description || '');
    
    showLoading();
    const { error: updateError } = await supabase.from('house_types').update({type_name: typeName, rent_amount: parseFloat(rentAmount), description: description || null}).eq('id', id).eq('user_id', currentUser.id);
    if (updateError) throw updateError;
    alert('House type updated successfully!');
    loadHouseTypes();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function deleteHouseType(id) {
  if (!confirm('Are you sure you want to delete this house type?')) return;
  try {
    showLoading();
    const { error } = await supabase.from('house_types').delete().eq('id', id).eq('user_id', currentUser.id);
    if (error) throw error;
    alert('House type deleted successfully!');
    loadHouseTypes();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function loadProperties() {
  try {
    showLoading();
    const { data, error } = await supabase.from('properties').select('*, house_types (type_name)').eq('user_id', currentUser.id).order('created_at', { ascending: false });
    if (error) throw error;
    
    const tbody = document.querySelector('#propertiesTable tbody');
    tbody.innerHTML = '';
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">No properties found. Click "+ Add Property" to get started.</td></tr>';
      return;
    }
    
    data.forEach(prop => {
      const houseTypeName = prop.house_types?.type_name || 'N/A';
      tbody.innerHTML += `<tr><td><strong>${prop.name}</strong></td><td>${prop.location}</td><td>${houseTypeName}</td><td>${prop.houses || 0}</td><td class="actions"><button class="edit" onclick="editProperty('${prop.id}')">Edit</button><button class="del" onclick="deleteProperty('${prop.id}')">Delete</button></td></tr>`;
    });
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function showAddPropertyForm() {
  const { data: houseTypes, error } = await supabase.from('house_types').select('*').eq('user_id', currentUser.id);
  if (error || !houseTypes || houseTypes.length === 0) {
    alert('Please add house types first! Go to House Types section.');
    return;
  }
  
  const name = prompt('Property Name:');
  if (!name) return;
  const location = prompt('Location:');
  if (!location) return;
  
  let houseTypeList = 'Available House Types:\n\n';
  houseTypes.forEach((ht, index) => {
    houseTypeList += `${index + 1}. ${ht.type_name} (Ksh ${Number(ht.rent_amount).toLocaleString()})\n`;
  });
  
  const houseTypeChoice = prompt(houseTypeList + '\nEnter the number of the house type:');
  if (!houseTypeChoice) return;
  const selectedHouseType = houseTypes[parseInt(houseTypeChoice) - 1];
  if (!selectedHouseType) {
    alert('Invalid house type selection');
    return;
  }
  
  const houses = prompt('Number of Houses:');
  if (!houses) return;
  addProperty(name, location, parseInt(houses), selectedHouseType.id);
}

async function addProperty(name, location, houses, houseTypeId) {
  try {
    showLoading();
    const { error } = await supabase.from('properties').insert([{name, location, houses, house_type_id: houseTypeId, user_id: currentUser.id}]);
    if (error) throw error;
    alert('Property added successfully!');
    loadProperties();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function editProperty(id) {
  try {
    showLoading();
    const { data, error } = await supabase.from('properties').select('*').eq('id', id).eq('user_id', currentUser.id).single();
    if (error) throw error;
    hideLoading();
    
    const name = prompt('Property Name:', data.name);
    if (!name) return;
    const location = prompt('Location:', data.location);
    if (!location) return;
    const houses = prompt('Number of Houses:', data.houses);
    if (!houses) return;
    
    showLoading();
    const { error: updateError } = await supabase.from('properties').update({name, location, houses: parseInt(houses)}).eq('id', id).eq('user_id', currentUser.id);
    if (updateError) throw updateError;
    alert('Property updated successfully!');
    loadProperties();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function deleteProperty(id) {
  if (!confirm('Are you sure you want to delete this property?')) return;
  try {
    showLoading();
    const { error } = await supabase.from('properties').delete().eq('id', id).eq('user_id', currentUser.id);
    if (error) throw error;
    alert('Property deleted successfully!');
    loadProperties();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

let allTenants = [];
let preFillTenantData = null;

async function loadTenants() {
  try {
    showLoading();
    const { data, error } = await supabase.from('tenants').select('*, properties (name, id), house_types (type_name, id)').eq('user_id', currentUser.id).order('created_at', { ascending: false });
    if (error) throw error;
    
    allTenants = data || [];
    await populateFilterDropdowns();
    renderTenants(allTenants);
    
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function populateFilterDropdowns() {
  try {
    const { data: properties } = await supabase.from('properties').select('id, name').eq('user_id', currentUser.id).order('name');
    const { data: houseTypes } = await supabase.from('house_types').select('id, type_name').eq('user_id', currentUser.id).order('type_name');
    
    const propertySelect = document.getElementById('filterProperty');
    propertySelect.innerHTML = '<option value="">All Properties</option>';
    if (properties) {
      properties.forEach(prop => {
        propertySelect.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
      });
    }
    
    const houseTypeSelect = document.getElementById('filterHouseType');
    houseTypeSelect.innerHTML = '<option value="">All House Types</option>';
    if (houseTypes) {
      houseTypes.forEach(ht => {
        houseTypeSelect.innerHTML += `<option value="${ht.id}">${ht.type_name}</option>`;
      });
    }
  } catch (error) {
    console.error('Error loading filters:', error);
  }
}

function filterTenants() {
  const propertyFilter = document.getElementById('filterProperty').value;
  const houseTypeFilter = document.getElementById('filterHouseType').value;
  const nameFilter = document.getElementById('filterTenantName').value.toLowerCase();
  
  let filteredTenants = allTenants;
  
  if (propertyFilter) {
    filteredTenants = filteredTenants.filter(t => t.property_id === propertyFilter);
  }
  
  if (houseTypeFilter) {
    filteredTenants = filteredTenants.filter(t => t.house_type_id === houseTypeFilter);
  }
  
  if (nameFilter) {
    filteredTenants = filteredTenants.filter(t => t.name.toLowerCase().includes(nameFilter));
  }
  
  renderTenants(filteredTenants);
  updateFilterStats(filteredTenants.length, allTenants.length);
}

function clearTenantFilters() {
  document.getElementById('filterProperty').value = '';
  document.getElementById('filterHouseType').value = '';
  document.getElementById('filterTenantName').value = '';
  renderTenants(allTenants);
  updateFilterStats(allTenants.length, allTenants.length);
}

function updateFilterStats(filtered, total) {
  const statsDiv = document.getElementById('filterStats');
  if (filtered === total) {
    statsDiv.innerHTML = `üìä Showing all ${total} tenant(s)`;
  } else {
    statsDiv.innerHTML = `üìä Showing ${filtered} of ${total} tenant(s) (${total - filtered} hidden by filters)`;
  }
}

function renderTenants(tenants) {
  const tbody = document.querySelector('#tenantsTable tbody');
  tbody.innerHTML = '';
  
  if (tenants.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #666;">No tenants found matching your filters. Try adjusting the filters or click "+ Add Tenant" to get started.</td></tr>';
    updateFilterStats(0, allTenants.length);
    return;
  }
  
  tenants.forEach(tenant => {
    const propertyName = tenant.properties?.name || 'N/A';
    const houseTypeName = tenant.house_types?.type_name || 'N/A';
    tbody.innerHTML += `<tr><td><strong>${tenant.name}</strong></td><td>${tenant.phone}</td><td>${tenant.email || 'N/A'}</td><td>${propertyName}</td><td>${houseTypeName}</td><td>${tenant.house_number}</td><td><strong style="color: var(--green);">Ksh ${Number(tenant.rent).toLocaleString()}</strong></td><td>${tenant.move_in_date || 'N/A'}</td><td class="actions"><button class="edit" onclick="editTenant('${tenant.id}')">Edit</button><button class="del" onclick="deleteTenant('${tenant.id}')">Delete</button></td></tr>`;
  });
  
  updateFilterStats(tenants.length, allTenants.length);
}

async function showAddTenantForm(propertyId = null, houseNumber = null) {
  const { data: properties } = await supabase.from('properties').select('*').eq('user_id', currentUser.id);
  if (!properties || properties.length === 0) {
    alert('Please add a property first!');
    return;
  }
  
  const { data: houseTypes } = await supabase.from('house_types').select('*').eq('user_id', currentUser.id);
  if (!houseTypes || houseTypes.length === 0) {
    alert('Please add house types first! Go to House Types section.');
    return;
  }
  
  let selectedProperty;
  
  if (propertyId) {
    selectedProperty = properties.find(p => p.id === propertyId);
    if (selectedProperty) {
      const confirmMsg = `Adding tenant to:\n\nüè¢ Property: ${selectedProperty.name}\nüè† House Number: ${houseNumber}\n\nContinue?`;
      if (!confirm(confirmMsg)) return;
    }
  }
  
  if (!selectedProperty) {
    let propertyList = 'Available Properties:\n\n';
    properties.forEach((prop, index) => {
      propertyList += `${index + 1}. ${prop.name} - ${prop.location}\n`;
    });
    const propertyChoice = prompt(propertyList + '\nEnter the number of the property:');
    if (!propertyChoice) return;
    selectedProperty = properties[parseInt(propertyChoice) - 1];
    if (!selectedProperty) {
      alert('Invalid property selection');
      return;
    }
  }
  
  let houseTypeList = 'Available House Types:\n\n';
  houseTypes.forEach((ht, index) => {
    houseTypeList += `${index + 1}. ${ht.type_name} (Ksh ${Number(ht.rent_amount).toLocaleString()})\n`;
  });
  const houseTypeChoice = prompt(houseTypeList + '\nEnter the number of the house type:');
  if (!houseTypeChoice) return;
  const selectedHouseType = houseTypes[parseInt(houseTypeChoice) - 1];
  if (!selectedHouseType) {
    alert('Invalid house type selection');
    return;
  }
  
  const name = prompt('Tenant Name:');
  if (!name) return;
  const phone = prompt('Phone Number:');
  if (!phone) return;
  const email = prompt('Email (optional):');
  const finalHouseNumber = houseNumber || prompt('House Number:');
  if (!finalHouseNumber) return;
  const moveInDate = prompt('Move-in Date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
  
  addTenant(selectedProperty.id, selectedHouseType.id, name, phone, email, finalHouseNumber, selectedHouseType.rent_amount, moveInDate);
}

async function addTenant(propertyId, houseTypeId, name, phone, email, houseNumber, rent, moveInDate) {
  try {
    showLoading();
    
    // Debug: Check if user is authenticated
    if (!currentUser || !currentUser.id) {
      throw new Error('User not authenticated. Please log in again.');
    }
    
    // Debug: Check required fields
    if (!propertyId || !houseTypeId || !name || !phone) {
      throw new Error('Missing required fields: property, house type, name, or phone.');
    }
    
    console.log('Adding tenant with data:', {
      property_id: propertyId, 
      house_type_id: houseTypeId, 
      name, 
      phone, 
      email: email || null, 
      house_number: houseNumber, 
      rent, 
      move_in_date: moveInDate, 
      user_id: currentUser.id
    });
    
    const { data, error } = await supabase.from('tenants').insert([{
      property_id: propertyId, 
      house_type_id: houseTypeId, 
      name, 
      phone, 
      email: email || null, 
      house_number: houseNumber, 
      rent, 
      move_in_date: moveInDate, 
      user_id: currentUser.id
    }]);
    
    if (error) {
      console.error('Supabase error:', error);
      throw error;
    }
    
    console.log('Tenant added successfully:', data);
    alert('Tenant added successfully!');
    loadTenants();
  } catch (error) {
    console.error('Add tenant error:', error);
    alert('Error adding tenant: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function editTenant(id) {
  try {
    showLoading();
    const { data, error } = await supabase.from('tenants').select('*').eq('id', id).eq('user_id', currentUser.id).single();
    if (error) throw error;
    hideLoading();
    
    const name = prompt('Tenant Name:', data.name);
    if (!name) return;
    const phone = prompt('Phone Number:', data.phone);
    if (!phone) return;
    const email = prompt('Email (optional):', data.email || '');
    const houseNumber = prompt('House Number:', data.house_number);
    if (!houseNumber) return;
    const rent = prompt('Monthly Rent (Ksh):', data.rent);
    if (!rent) return;
    
    showLoading();
    const { error: updateError } = await supabase.from('tenants').update({name, phone, email: email || null, house_number: houseNumber, rent: parseFloat(rent)}).eq('id', id).eq('user_id', currentUser.id);
    if (updateError) throw updateError;
    alert('Tenant updated successfully!');
    loadTenants();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function deleteTenant(id) {
  if (!confirm('Are you sure you want to delete this tenant?')) return;
  try {
    showLoading();
    const { error } = await supabase.from('tenants').delete().eq('id', id).eq('user_id', currentUser.id);
    if (error) throw error;
    alert('Tenant deleted successfully!');
    loadTenants();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

let allInvoices = [];
let allTenantsForInvoice = [];

async function loadInvoices() {
  await populateInvoiceFilterDropdowns();
  try {
    showLoading();
    const { data, error } = await supabase.from('invoices')
      .select(`
        *, 
        tenants(name, email, phone)
      `)
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });
    if (error) throw error;
    
    allInvoices = data || [];
    
    const tbody = document.querySelector('#invoicesTable tbody');
    tbody.innerHTML = '';
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">No invoices found. Click "Generate Monthly Invoices" to create invoices.</td></tr>';
      return;
    }
    
    data.forEach(invoice => {
      const statusClass = invoice.status === 'paid' ? 'status-paid' : invoice.status === 'overdue' ? 'status-overdue' : 'status-pending';
      const displayInvoiceNumber = invoice.invoice_number || `#${invoice.id}`;
      
      // Check if it's a custom invoice with detailed bills
      const isCustomInvoice = invoice.bill_details || invoice.custom_invoice;
      const actionButtons = `
        <button class="view" onclick="generateEnhancedInvoicePDF('${invoice.tenant_id}')" title="Enhanced PDF">üìÑ PDF</button>
        ${invoice.status === 'unpaid' ? `<button class="edit" onclick="markInvoicePaid('${invoice.id}')">Mark Paid</button>` : ''}
        <button class="del" onclick="deleteInvoice('${invoice.id}')">Delete</button>
      `;
      
      tbody.innerHTML += `<tr>
        <td><strong>${displayInvoiceNumber}</strong>${isCustomInvoice ? '<br><small style="color: var(--green);">‚ú® Custom Invoice</small>' : ''}</td>
        <td>${invoice.tenant_name}</td>
        <td>${invoice.house_number}</td>
        <td><strong style="color: var(--green);">Ksh ${Number(invoice.amount).toLocaleString()}</strong></td>
        <td>${invoice.due_date}</td>
        <td><span class="status-badge ${statusClass}">${invoice.status}</span></td>
        <td class="actions">${actionButtons}</td>
      </tr>`;
    });
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function generateInvoices() {
  if (!confirm('Generate monthly invoices for all current tenants?')) return;
  try {
    showLoading();
    const { data: tenants, error } = await supabase.from('tenants').select('*').eq('user_id', currentUser.id);
    if (error) throw error;
    if (!tenants || tenants.length === 0) {
      alert('No tenants found. Please add tenants first.');
      return;
    }
    
    const currentDate = new Date();
    const month = currentDate.getMonth() + 1;
    const year = currentDate.getFullYear();
    const dueDate = new Date(year, month - 1, 5);
    
    const invoicesToCreate = [];
    for (const tenant of tenants) {
      // Skip tenants without rent amount set
      if (!tenant.rent || tenant.rent <= 0) {
        console.log(`Skipping tenant ${tenant.name} - no rent amount set`);
        continue;
      }
      const invoiceNumber = `INV-${year}${month.toString().padStart(2, '0')}-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
      invoicesToCreate.push({invoice_number: invoiceNumber, tenant_id: tenant.id, tenant_name: tenant.name, property_id: tenant.property_id, house_type_id: tenant.house_type_id, house_number: tenant.house_number, amount: tenant.rent, due_date: dueDate.toISOString().split('T')[0], status: 'unpaid', generated_date: currentDate.toISOString().split('T')[0], month, year, user_id: currentUser.id});
    }
    
    if (invoicesToCreate.length === 0) {
      alert('No invoices to generate. Please ensure all tenants have rent amounts set.');
      return;
    }
    
    const { error: insertError } = await supabase.from('invoices').insert(invoicesToCreate);
    if (insertError) throw insertError;
    alert(`Successfully generated ${invoicesToCreate.length} invoice(s)!`);
    loadInvoices();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function markInvoicePaid(id) {
  try {
    showLoading();
    const { error } = await supabase.from('invoices').update({status: 'paid', paid_date: new Date().toISOString().split('T')[0]}).eq('id', id).eq('user_id', currentUser.id);
    if (error) throw error;
    alert('Invoice marked as paid!');
    loadInvoices();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function populateInvoiceFilterDropdowns() {
  try {
    const { data: properties } = await supabase.from('properties').select('id, name').eq('user_id', currentUser.id).order('name');
    const { data: tenants } = await supabase.from('tenants').select('id, name, property_id, house_type_id, house_number, rent').eq('user_id', currentUser.id).order('name');
    
    allTenantsForInvoice = tenants || [];
    
    const propertySelect = document.getElementById('invoiceFilterProperty');
    propertySelect.innerHTML = '<option value="">Select Property</option>';
    if (properties) {
      properties.forEach(prop => {
        propertySelect.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
      });
    }
  } catch (error) {
    console.error('Error loading invoice filters:', error);
  }
}

async function updateInvoiceHouseTypes() {
  const propertyId = document.getElementById('invoiceFilterProperty').value;
  const houseTypeSelect = document.getElementById('invoiceFilterHouseType');
  const tenantSelect = document.getElementById('invoiceFilterTenant');
  
  houseTypeSelect.innerHTML = '<option value="">Select House Type</option>';
  tenantSelect.innerHTML = '<option value="">Select Tenant</option>';
  
  if (!propertyId) {
    document.getElementById('invoiceFilterInfo').innerHTML = '';
    return;
  }
  
  try {
    const { data: property } = await supabase.from('properties').select('*, house_types(id, type_name, rent_amount)').eq('id', propertyId).single();
    
    if (property && property.house_types) {
      houseTypeSelect.innerHTML += `<option value="${property.house_types.id}">${property.house_types.type_name} (Ksh ${Number(property.house_types.rent_amount).toLocaleString()})</option>`;
    }
    
    const tenantsInProperty = allTenantsForInvoice.filter(t => t.property_id === propertyId);
    document.getElementById('invoiceFilterInfo').innerHTML = `üìä ${tenantsInProperty.length} tenant(s) in ${property.name}`;
    
  } catch (error) {
    console.error('Error:', error);
  }
}

async function updateInvoiceTenants() {
  const propertyId = document.getElementById('invoiceFilterProperty').value;
  const houseTypeId = document.getElementById('invoiceFilterHouseType').value;
  const tenantSelect = document.getElementById('invoiceFilterTenant');
  
  tenantSelect.innerHTML = '<option value="">Select Tenant</option>';
  
  if (!propertyId || !houseTypeId) return;
  
  const filteredTenants = allTenantsForInvoice.filter(t => 
    t.property_id === propertyId && t.house_type_id === houseTypeId
  );
  
  filteredTenants.forEach(tenant => {
    tenantSelect.innerHTML += `<option value="${tenant.id}">${tenant.name} - House ${tenant.house_number} (Ksh ${Number(tenant.rent).toLocaleString()})</option>`;
  });
  
  if (filteredTenants.length > 0) {
    document.getElementById('invoiceFilterInfo').innerHTML = `‚úÖ ${filteredTenants.length} tenant(s) available for invoice generation`;
  } else {
    document.getElementById('invoiceFilterInfo').innerHTML = `‚ö†Ô∏è No tenants found for this house type`;
  }
}

async function generateSingleInvoice() {
  const tenantId = document.getElementById('invoiceFilterTenant').value;
  
  if (!tenantId) {
    alert('Please select a tenant first!');
    return;
  }
  
  try {
    showLoading();
    const { data: tenant, error } = await supabase.from('tenants').select('*').eq('id', tenantId).single();
    if (error) throw error;
    
    if (!tenant.rent || tenant.rent <= 0) {
      alert(`Tenant ${tenant.name} has no rent amount set!`);
      return;
    }
    
    const currentDate = new Date();
    const month = currentDate.getMonth() + 1;
    const year = currentDate.getFullYear();
    const dueDate = new Date(year, month - 1, 5);
    
    const invoiceNumber = `INV-${year}${month.toString().padStart(2, '0')}-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
    
    const { error: insertError } = await supabase.from('invoices').insert([{
      invoice_number: invoiceNumber,
      tenant_id: tenant.id,
      tenant_name: tenant.name,
      property_id: tenant.property_id,
      house_type_id: tenant.house_type_id,
      house_number: tenant.house_number,
      amount: tenant.rent,
      due_date: dueDate.toISOString().split('T')[0],
      status: 'unpaid',
      generated_date: currentDate.toISOString().split('T')[0],
      month,
      year,
      user_id: currentUser.id
    }]);
    
    if (insertError) throw insertError;
    
    alert(`‚úÖ Invoice generated successfully for ${tenant.name}!\nInvoice #: ${invoiceNumber}`);
    loadInvoices();
    
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function exportSingleInvoicePDF() {
  const tenantId = document.getElementById('invoiceFilterTenant').value;
  
  if (!tenantId) {
    alert('Please select a tenant first!');
    return;
  }
  
  try {
    showLoading();
    const { data: invoices, error } = await supabase
      .from('invoices')
      .select('*, tenants(name, phone, email), properties(name, location)')
      .eq('tenant_id', tenantId)
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false })
      .limit(1);
    
    if (error) throw error;
    
    if (!invoices || invoices.length === 0) {
      alert('No invoice found for this tenant. Please generate one first.');
      return;
    }
    
    const invoice = invoices[0];
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(24);
    doc.setTextColor(11, 11, 11);
    doc.text('INVOICE', 105, 20, { align: 'center' });
    
    // Invoice details
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text(`Invoice #: ${invoice.invoice_number || '#' + invoice.id}`, 14, 35);
    doc.text(`Generated: ${invoice.generated_date}`, 14, 41);
    doc.text(`Due Date: ${invoice.due_date}`, 14, 47);
    
    // Tenant details
    doc.setFontSize(12);
    doc.setTextColor(11, 11, 11);
    doc.text('BILL TO:', 14, 60);
    doc.setFontSize(10);
    doc.setTextColor(60, 60, 60);
    doc.text(invoice.tenant_name, 14, 67);
    if (invoice.tenants?.phone) doc.text(`Phone: ${invoice.tenants.phone}`, 14, 73);
    if (invoice.tenants?.email) doc.text(`Email: ${invoice.tenants.email}`, 14, 79);
    doc.text(`House: ${invoice.house_number}`, 14, 85);
    if (invoice.properties) {
      doc.text(`Property: ${invoice.properties.name}`, 14, 91);
      doc.text(`Location: ${invoice.properties.location}`, 14, 97);
    }
    
    // Invoice table
    doc.autoTable({
      startY: 110,
      head: [['Description', 'Period', 'Amount']],
      body: [[
        'Monthly Rent',
        `${getMonthName(invoice.month)} ${invoice.year}`,
        `Ksh ${Number(invoice.amount).toLocaleString()}`
      ]],
      theme: 'striped',
      headStyles: { fillColor: [11, 11, 11], fontSize: 11 },
      styles: { fontSize: 10 }
    });
    
    // Total
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(14);
    doc.setTextColor(39, 174, 96);
    doc.text(`TOTAL: Ksh ${Number(invoice.amount).toLocaleString()}`, 14, finalY);
    
    // Status
    doc.setFontSize(10);
    if (invoice.status === 'paid') {
      doc.setTextColor(39, 174, 96);
      doc.text(`STATUS: PAID (${invoice.paid_date})`, 14, finalY + 10);
    } else {
      doc.setTextColor(192, 57, 43);
      doc.text('STATUS: UNPAID', 14, finalY + 10);
    }
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('Thank you for your business!', 105, 280, { align: 'center' });
    doc.text('CHARLES SOFTWARE 2025', 105, 285, { align: 'center' });
    
    doc.save(`Invoice_${invoice.invoice_number || invoice.id}_${invoice.tenant_name.replace(/\s+/g, '_')}.pdf`);
    alert('‚úÖ Invoice PDF exported successfully!');
    
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

function getMonthName(monthNumber) {
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  return months[monthNumber - 1] || '';
}

async function deleteInvoice(id) {
  if (!confirm('Are you sure you want to delete this invoice?')) return;
  try {
    showLoading();
    const { error } = await supabase.from('invoices').delete().eq('id', id).eq('user_id', currentUser.id);
    if (error) throw error;
    alert('Invoice deleted successfully!');
    loadInvoices();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ============ ENHANCED INVOICE SYSTEM ============

async function showCreateInvoiceModal() {
  try {
    showLoading();
    const { data: tenants, error } = await supabase
      .from('tenants')
      .select(`
        id, name, phone, email, rent, house_number,
        properties (name),
        house_types (type_name)
      `)
      .eq('user_id', currentUser.id)
      .order('name');
    
    if (error) throw error;
    
    const tenantSelect = document.getElementById('invoiceTenant');
    tenantSelect.innerHTML = '<option value="">Choose a tenant...</option>';
    
    if (tenants && tenants.length > 0) {
      tenants.forEach(tenant => {
        const propertyName = tenant.properties?.name || 'N/A';
        const houseType = tenant.house_types?.type_name || '';
        tenantSelect.innerHTML += `
          <option value="${tenant.id}" 
                  data-rent="${tenant.rent}" 
                  data-property="${propertyName}" 
                  data-house="${tenant.house_number}"
                  data-email="${tenant.email || ''}"
                  data-phone="${tenant.phone || ''}">
            ${tenant.name} - House ${tenant.house_number} (${propertyName})
          </option>
        `;
      });
    }
    
    // Set default due date to 5th of next month
    const today = new Date();
    const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 5);
    document.getElementById('invoiceDueDate').value = nextMonth.toISOString().split('T')[0];
    
    // Set default period
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                   'July', 'August', 'September', 'October', 'November', 'December'];
    const currentMonth = months[today.getMonth()];
    const currentYear = today.getFullYear();
    document.getElementById('invoicePeriod').value = `${currentMonth} ${currentYear}`;
    
    document.getElementById('invoiceModal').classList.add('show');
    updateInvoiceTotal(); // Initialize total
    
  } catch (error) {
    alert('Error loading tenants: ' + error.message);
  } finally {
    hideLoading();
  }
}

function hideCreateInvoiceModal() {
  document.getElementById('invoiceModal').classList.remove('show');
  // Reset form
  document.getElementById('invoiceTenant').value = '';
  document.getElementById('invoiceProperty').value = '';
  document.getElementById('invoiceHouseNumber').value = '';
  document.getElementById('invoiceRent').value = '';
  document.getElementById('invoicePeriod').value = '';
  document.getElementById('invoiceDueDate').value = '';
  document.getElementById('invoiceWaterBill').value = '0';
  document.getElementById('invoiceElectricity').value = '0';
  document.getElementById('invoiceWasteManagement').value = '0';
  document.getElementById('invoiceServiceFee').value = '0';
  document.getElementById('invoiceNotes').value = '';
  updateInvoiceTotal();
}

function loadTenantInfo() {
  const tenantSelect = document.getElementById('invoiceTenant');
  const selectedOption = tenantSelect.options[tenantSelect.selectedIndex];
  
  if (selectedOption && selectedOption.value) {
    document.getElementById('invoiceProperty').value = selectedOption.dataset.property;
    document.getElementById('invoiceHouseNumber').value = selectedOption.dataset.house;
    document.getElementById('invoiceRent').value = selectedOption.dataset.rent;
    updateInvoiceTotal();
  } else {
    document.getElementById('invoiceProperty').value = '';
    document.getElementById('invoiceHouseNumber').value = '';
    document.getElementById('invoiceRent').value = '';
    updateInvoiceTotal();
  }
}

function updateInvoiceTotal() {
  const rent = parseFloat(document.getElementById('invoiceRent').value) || 0;
  const waterBill = parseFloat(document.getElementById('invoiceWaterBill').value) || 0;
  const electricity = parseFloat(document.getElementById('invoiceElectricity').value) || 0;
  const wasteManagement = parseFloat(document.getElementById('invoiceWasteManagement').value) || 0;
  const serviceFee = parseFloat(document.getElementById('invoiceServiceFee').value) || 0;
  
  const total = rent + waterBill + electricity + wasteManagement + serviceFee;
  document.getElementById('invoiceTotal').textContent = `Ksh ${total.toLocaleString()}`;
}

async function generateCustomInvoice() {
  const tenantId = document.getElementById('invoiceTenant').value;
  const period = document.getElementById('invoicePeriod').value;
  const dueDate = document.getElementById('invoiceDueDate').value;
  const rent = parseFloat(document.getElementById('invoiceRent').value) || 0;
  const waterBill = parseFloat(document.getElementById('invoiceWaterBill').value) || 0;
  const electricity = parseFloat(document.getElementById('invoiceElectricity').value) || 0;
  const wasteManagement = parseFloat(document.getElementById('invoiceWasteManagement').value) || 0;
  const serviceFee = parseFloat(document.getElementById('invoiceServiceFee').value) || 0;
  const notes = document.getElementById('invoiceNotes').value;
  
  if (!tenantId || !period || !dueDate) {
    alert('Please fill in all required fields!');
    return;
  }
  
  try {
    showLoading();
    
    // Get tenant details
    const { data: tenant, error } = await supabase
      .from('tenants')
      .select(`
        id, name, phone, email, property_id, house_type_id, house_number,
        properties (name, location),
        house_types (type_name)
      `)
      .eq('id', tenantId)
      .single();
    
    if (error) throw error;
    
    // Generate unique invoice number
    const currentDate = new Date();
    const invoiceNumber = `INV-${currentDate.getFullYear()}${String(currentDate.getMonth() + 1).padStart(2, '0')}${String(currentDate.getDate()).padStart(2, '0')}-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
    
    // Calculate total
    const totalAmount = rent + waterBill + electricity + wasteManagement + serviceFee;
    
    // Create detailed bill breakdown for storage
    const billDetails = {
      rent: rent,
      water_bill: waterBill,
      electricity: electricity,
      waste_management: wasteManagement,
      service_fee: serviceFee,
      notes: notes || null
    };
    
    // Insert invoice into database
    const { error: insertError } = await supabase.from('invoices').insert([{
      invoice_number: invoiceNumber,
      tenant_id: tenant.id,
      tenant_name: tenant.name,
      property_id: tenant.property_id,
      house_type_id: tenant.house_type_id,
      house_number: tenant.house_number,
      amount: totalAmount,
      due_date: dueDate,
      status: 'unpaid',
      generated_date: currentDate.toISOString().split('T')[0],
      month: currentDate.getMonth() + 1,
      year: currentDate.getFullYear(),
      user_id: currentUser.id,
      invoice_period: period,
      bill_details: billDetails,
      custom_invoice: true
    }]);
    
    if (insertError) throw insertError;
    
    alert(`‚úÖ Custom invoice generated successfully!\n\nInvoice #: ${invoiceNumber}\nTenant: ${tenant.name}\nTotal Amount: Ksh ${totalAmount.toLocaleString()}\n\nBill Breakdown:\n‚Ä¢ Rent: Ksh ${rent.toLocaleString()}\n‚Ä¢ Water Bill: Ksh ${waterBill.toLocaleString()}\n‚Ä¢ Electricity: Ksh ${electricity.toLocaleString()}\n‚Ä¢ Waste Management: Ksh ${wasteManagement.toLocaleString()}\n‚Ä¢ Service Fee: Ksh ${serviceFee.toLocaleString()}`);
    
    hideCreateInvoiceModal();
    loadInvoices();
    
  } catch (error) {
    alert('Error generating invoice: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function previewInvoicePDF() {
  const tenantId = document.getElementById('invoiceTenant').value;
  if (!tenantId) {
    alert('Please select a tenant first!');
    return;
  }
  
  await generateEnhancedInvoicePDF(tenantId, true); // true = preview mode
}

async function generateEnhancedInvoicePDF(tenantId, isPreview = false) {
  try {
    if (!isPreview) showLoading();
    
    // Get the latest invoice for this tenant
    const { data: invoices, error } = await supabase
      .from('invoices')
      .select(`
        *, tenants(name, phone, email), 
        properties(name, location), 
        house_types(type_name)
      `)
      .eq('tenant_id', tenantId)
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false })
      .limit(1);
    
    if (error) throw error;
    
    if (!invoices || invoices.length === 0) {
      alert('No invoice found for this tenant. Please generate one first.');
      return;
    }
    
    const invoice = invoices[0];
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header with professional styling
    doc.setFillColor(11, 11, 11);
    doc.rect(0, 0, 210, 25, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(28);
    doc.text('INVOICE', 105, 17, { align: 'center' });
    
    doc.setFontSize(10);
    doc.text('RentPoa Property Management', 105, 22, { align: 'center' });
    
    // Reset text color
    doc.setTextColor(11, 11, 11);
    
    let yPos = 35;
    
    // Invoice details
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text('INVOICE DETAILS', 14, yPos);
    
    yPos += 8;
    doc.setFontSize(10);
    doc.text(`Invoice #: ${invoice.invoice_number || '#' + invoice.id}`, 14, yPos);
    doc.text(`Generated: ${invoice.generated_date}`, 14, yPos + 6);
    doc.text(`Due Date: ${invoice.due_date}`, 14, yPos + 12);
    doc.text(`Period: ${invoice.invoice_period || `${getMonthName(invoice.month)} ${invoice.year}`}`, 14, yPos + 18);
    
    // Tenant details
    yPos += 30;
    doc.setFontSize(12);
    doc.setTextColor(11, 11, 11);
    doc.text('BILL TO:', 14, yPos);
    
    yPos += 8;
    doc.setFontSize(10);
    doc.setTextColor(60, 60, 60);
    doc.text(invoice.tenant_name, 14, yPos);
    if (invoice.tenants?.phone) doc.text(`Phone: ${invoice.tenants.phone}`, 14, yPos + 6);
    if (invoice.tenants?.email) doc.text(`Email: ${invoice.tenants.email}`, 14, yPos + 12);
    doc.text(`House: ${invoice.house_number}`, 14, yPos + 18);
    if (invoice.properties) {
      doc.text(`Property: ${invoice.properties.name}`, 14, yPos + 24);
      doc.text(`Location: ${invoice.properties.location}`, 14, yPos + 30);
    }
    
    // Invoice items table
    yPos += 40;
    
    // Check if this is a custom invoice with detailed bill breakdown
    let tableBody = [];
    if (invoice.bill_details) {
      const billDetails = invoice.bill_details;
      if (billDetails.rent > 0) tableBody.push(['Monthly Rent', invoice.invoice_period || `${getMonthName(invoice.month)} ${invoice.year}`, `Ksh ${Number(billDetails.rent).toLocaleString()}`]);
      if (billDetails.water_bill > 0) tableBody.push(['Water Bill', 'Current Period', `Ksh ${Number(billDetails.water_bill).toLocaleString()}`]);
      if (billDetails.electricity > 0) tableBody.push(['Electricity', 'Current Period', `Ksh ${Number(billDetails.electricity).toLocaleString()}`]);
      if (billDetails.waste_management > 0) tableBody.push(['Waste Management', 'Current Period', `Ksh ${Number(billDetails.waste_management).toLocaleString()}`]);
      if (billDetails.service_fee > 0) tableBody.push(['Service Fee', 'Current Period', `Ksh ${Number(billDetails.service_fee).toLocaleString()}`]);
    } else {
      // Fallback for old invoices
      tableBody.push(['Monthly Rent', invoice.invoice_period || `${getMonthName(invoice.month)} ${invoice.year}`, `Ksh ${Number(invoice.amount).toLocaleString()}`]);
    }
    
    doc.autoTable({
      startY: yPos,
      head: [['Description', 'Period', 'Amount']],
      body: tableBody,
      theme: 'striped',
      headStyles: { 
        fillColor: [11, 11, 11], 
        textColor: [255, 255, 255],
        fontSize: 11 
      },
      styles: { fontSize: 10 },
      columnStyles: {
        2: { halign: 'right' }
      }
    });
    
    // Total
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(14);
    doc.setTextColor(39, 174, 96);
    doc.text(`TOTAL: Ksh ${Number(invoice.amount).toLocaleString()}`, 14, finalY);
    
    // Status
    doc.setFontSize(10);
    if (invoice.status === 'paid') {
      doc.setTextColor(39, 174, 96);
      doc.text(`STATUS: PAID (${invoice.paid_date})`, 14, finalY + 10);
    } else {
      doc.setTextColor(192, 57, 43);
      doc.text('STATUS: UNPAID', 14, finalY + 10);
    }
    
    // Notes if available
    if (invoice.bill_details?.notes) {
      doc.setTextColor(100, 100, 100);
      doc.setFontSize(9);
      const notesY = finalY + 20;
      doc.text('NOTES:', 14, notesY);
      doc.text(invoice.bill_details.notes, 14, notesY + 6, { maxWidth: 180 });
    }
    
    // Footer
    doc.setTextColor(150, 150, 150);
    doc.setFontSize(8);
    doc.text('Thank you for your business!', 105, 285, { align: 'center' });
    doc.text('CHARLES SOFTWARE 2025', 105, 290, { align: 'center' });
    
    if (!isPreview) {
      doc.save(`Enhanced_Invoice_${invoice.invoice_number || invoice.id}_${invoice.tenant_name.replace(/\s+/g, '_')}.pdf`);
      alert('‚úÖ Enhanced invoice PDF exported successfully!');
    } else {
      // Preview in new window
      const pdfBlob = doc.output('blob');
      const pdfUrl = URL.createObjectURL(pdfBlob);
      window.open(pdfUrl, '_blank');
    }
    
  } catch (error) {
    alert('Error generating PDF: ' + error.message);
  } finally {
    if (!isPreview) hideLoading();
  }
}

function viewInvoices() {
  loadInvoices(); // This already exists
}

async function loadPayments() {
  try {
    showLoading();
    const { data, error } = await supabase.from('payments').select('*').eq('user_id', currentUser.id).order('date', { ascending: false });
    if (error) throw error;
    
    const tbody = document.querySelector('#paymentsTable tbody');
    tbody.innerHTML = '';
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">No payments recorded. Click "+ Record Payment" to add a payment.</td></tr>';
      return;
    }
    
    data.forEach(payment => {
      tbody.innerHTML += `<tr><td>${payment.date}</td><td>${payment.tenant_name}</td><td>${payment.house_number}</td><td><strong style="color: var(--green);">Ksh ${Number(payment.amount).toLocaleString()}</strong></td><td>${payment.method}</td><td>${payment.reference || 'N/A'}</td><td class="actions"><button class="del" onclick="deletePayment('${payment.id}')">Delete</button></td></tr>`;
    });
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function showRecordPaymentForm() {
  const { data: tenants, error } = await supabase.from('tenants').select('*').eq('user_id', currentUser.id);
  if (error || !tenants || tenants.length === 0) {
    alert('Please add tenants first!');
    return;
  }
  
  let tenantList = 'Available Tenants:\n\n';
  tenants.forEach((tenant, index) => {
    tenantList += `${index + 1}. ${tenant.name} - House ${tenant.house_number} (Rent: Ksh ${Number(tenant.rent).toLocaleString()})\n`;
  });
  const tenantChoice = prompt(tenantList + '\nEnter the number of the tenant:');
  if (!tenantChoice) return;
  const selectedTenant = tenants[parseInt(tenantChoice) - 1];
  if (!selectedTenant) {
    alert('Invalid tenant selection');
    return;
  }
  
  const amount = prompt(`Amount (Ksh):`, selectedTenant.rent);
  if (!amount) return;
  const date = prompt('Payment Date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
  if (!date) return;
  const method = prompt('Payment Method (Cash/M-Pesa/Bank Transfer):');
  if (!method) return;
  const reference = prompt('Reference Number (optional):');
  
  recordPayment(selectedTenant.id, selectedTenant.name, selectedTenant.property_id, selectedTenant.house_number, parseFloat(amount), date, method, reference);
}

async function recordPayment(tenantId, tenantName, propertyId, houseNumber, amount, date, method, reference) {
  try {
    showLoading();
    const paymentId = `PAY-${Date.now()}`;
    const { error } = await supabase.from('payments').insert([{id: paymentId, tenant_id: tenantId, tenant_name: tenantName, property_id: propertyId, house_number: houseNumber, amount, date, method, reference: reference || null, user_id: currentUser.id}]);
    if (error) throw error;
    
    await supabase.from('invoices').update({status: 'paid', paid_date: date}).eq('tenant_id', tenantId).eq('status', 'unpaid').limit(1);
    alert('Payment recorded successfully!');
    loadPayments();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function deletePayment(id) {
  if (!confirm('Are you sure you want to delete this payment?')) return;
  try {
    showLoading();
    const { error } = await supabase.from('payments').delete().eq('id', id).eq('user_id', currentUser.id);
    if (error) throw error;
    alert('Payment deleted successfully!');
    loadPayments();
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function exportInvoicesData() {
  try {
    showLoading();
    const { data, error } = await supabase.from('invoices').select('*').eq('user_id', currentUser.id);
    if (error) throw error;
    if (!data || data.length === 0) {
      alert('No invoices to export');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(20);
    doc.text('Invoices Report', 14, 20);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);
    
    const tableData = data.map(invoice => [invoice.invoice_number || `#${invoice.id}`, invoice.tenant_name, invoice.house_number, `Ksh ${Number(invoice.amount).toLocaleString()}`, invoice.due_date, invoice.status]);
    doc.autoTable({startY: 35, head: [['Invoice #', 'Tenant', 'House', 'Amount', 'Due Date', 'Status']], body: tableData, theme: 'striped', headStyles: { fillColor: [11, 11, 11] }, styles: { fontSize: 8 }});
    
    const totalAmount = data.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0);
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(12);
    doc.text(`Total Amount: Ksh ${totalAmount.toLocaleString()}`, 14, finalY);
    doc.text(`Total Invoices: ${data.length}`, 14, finalY + 7);
    doc.save(`Invoices_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    alert('Invoices report exported successfully!');
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function exportPaymentsData() {
  try {
    showLoading();
    const { data, error } = await supabase.from('payments').select('*').eq('user_id', currentUser.id);
    if (error) throw error;
    if (!data || data.length === 0) {
      alert('No payments to export');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(20);
    doc.text('Payments Report', 14, 20);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);
    
    const tableData = data.map(payment => [payment.date, payment.tenant_name, payment.house_number, `Ksh ${Number(payment.amount).toLocaleString()}`, payment.method, payment.reference || 'N/A']);
    doc.autoTable({startY: 35, head: [['Date', 'Tenant', 'House', 'Amount', 'Method', 'Reference']], body: tableData, theme: 'striped', headStyles: { fillColor: [11, 11, 11] }, styles: { fontSize: 8 }});
    
    const totalAmount = data.reduce((sum, pay) => sum + parseFloat(pay.amount || 0), 0);
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(12);
    doc.text(`Total Payments: Ksh ${totalAmount.toLocaleString()}`, 14, finalY);
    doc.text(`Number of Payments: ${data.length}`, 14, finalY + 7);
    doc.save(`Payments_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    alert('Payments report exported successfully!');
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

// ========== RECEIPTS FUNCTIONALITY ==========

let allReceipts = [];

// Add this diagnostic function after the renderReceipts function
function diagnoseInvoiceData() {
  // This function helps debug invoice data issues
  console.log('=== DIAGNOSIS REPORT ===');
  console.log('Current User ID:', currentUser?.id);
  console.log('User Email:', currentUser?.email);
  console.log('Number of receipts loaded:', allReceipts?.length || 0);
  
  if (allReceipts && allReceipts.length > 0) {
    console.log('Sample receipt structure:', allReceipts[0]);
  }
  
  // Check for any console errors
  console.log('Check the console above for any error messages');
  
  // Show this function in console for debugging
  console.log('To diagnose invoice data, run: diagnoseInvoiceData()');
}

async function loadReceipts() {
  await populateReceiptFilters();
  try {
    showLoading();
    console.log('Loading receipts for user:', currentUser.id);
    
    // Load paid invoices with proper joins to get property and tenant information
    const { data, error } = await supabase.from('invoices')
      .select(`
        *,
        tenants(id, name, email, phone, property_id),
        properties(id, name)
      `)
      .eq('user_id', currentUser.id)
      .ilike('status', 'paid')
      .order('paid_date', { ascending: false });
    
    if (error) throw error;
    
    console.log('Found paid invoices:', data);
    allReceipts = data || [];
    
    renderReceipts(allReceipts);
  } catch (error) {
    console.error('Error loading receipts:', error);
    alert('Error loading receipts: ' + error.message);
  } finally {
    hideLoading();
  }
}

async function populateReceiptFilters() {
  try {
    // Get properties for filter
    const { data: properties } = await supabase.from('properties').select('id, name').eq('user_id', currentUser.id).order('name');
    
    const propertySelect = document.getElementById('receiptPropertyFilter');
    propertySelect.innerHTML = '<option value="">All Properties</option>';
    if (properties) {
      properties.forEach(prop => {
        propertySelect.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
      });
    }
    
    // Load all tenants initially (when no property is selected)
    await loadAllTenants();
  } catch (error) {
    console.error('Error loading receipt filters:', error);
  }
}

function onPropertyFilterChange() {
  const propertyFilter = document.getElementById('receiptPropertyFilter').value;
  
  // Clear tenant filter when property changes
  document.getElementById('receiptTenantFilter').value = '';
  
  // Populate tenants based on selected property
  if (propertyFilter) {
    populateTenantsForProperty(propertyFilter);
  } else {
    loadAllTenants();
  }
  
  // Apply the filter
  filterReceipts();
}

function filterReceipts() {
  const propertyFilter = document.getElementById('receiptPropertyFilter').value;
  const tenantFilter = document.getElementById('receiptTenantFilter').value;
  
  console.log('Filtering receipts - Property:', propertyFilter, 'Tenant:', tenantFilter);
  console.log('Total receipts to filter:', allReceipts.length);
  
  let filteredReceipts = [...allReceipts]; // Create a copy to avoid modifying original
  
  // Filter by property - match tenant's property_id with selected property
  if (propertyFilter) {
    filteredReceipts = filteredReceipts.filter(receipt => {
      const matchesProperty = receipt.tenants?.property_id === propertyFilter;
      console.log('Property filter check:', {
        receiptId: receipt.id,
        tenantPropertyId: receipt.tenants?.property_id,
        filterPropertyId: propertyFilter,
        matches: matchesProperty,
        tenantName: receipt.tenants?.name
      });
      return matchesProperty;
    });
  }
  
  // Filter by tenant
  if (tenantFilter) {
    filteredReceipts = filteredReceipts.filter(receipt => {
      const matchesTenant = receipt.tenants?.id === tenantFilter;
      console.log('Tenant filter check:', {
        receiptId: receipt.id,
        tenantId: receipt.tenants?.id,
        filterTenantId: tenantFilter,
        matches: matchesTenant,
        tenantName: receipt.tenants?.name
      });
      return matchesTenant;
    });
  }
  
  console.log('Filtered receipts count:', filteredReceipts.length);
  renderReceipts(filteredReceipts);
}

async function loadAllTenants() {
  try {
    const { data: tenants } = await supabase.from('tenants')
      .select('id, name, phone, property_id')
      .eq('user_id', currentUser.id)
      .order('name');
    
    const tenantSelect = document.getElementById('receiptTenantFilter');
    tenantSelect.innerHTML = '<option value="">All Tenants</option>';
    if (tenants) {
      tenants.forEach(tenant => {
        tenantSelect.innerHTML += `<option value="${tenant.id}">${tenant.name} (${tenant.phone})</option>`;
      });
    }
  } catch (error) {
    console.error('Error loading all tenants:', error);
  }
}

async function populateTenantsForProperty(propertyId) {
  try {
    const { data: tenants } = await supabase.from('tenants')
      .select('id, name, phone, property_id')
      .eq('user_id', currentUser.id)
      .eq('property_id', propertyId)
      .order('name');
    
    const tenantSelect = document.getElementById('receiptTenantFilter');
    tenantSelect.innerHTML = '<option value="">All Tenants</option>';
    if (tenants) {
      tenants.forEach(tenant => {
        tenantSelect.innerHTML += `<option value="${tenant.id}">${tenant.name} (${tenant.phone})</option>`;
      });
    }
  } catch (error) {
    console.error('Error loading tenants for property:', error);
  }
}

async function clearReceiptFilters() {
  document.getElementById('receiptPropertyFilter').value = '';
  document.getElementById('receiptTenantFilter').value = '';
  
  // Reload all tenants
  await loadAllTenants();
  
  renderReceipts(allReceipts);
}

function renderReceipts(receipts) {
  const tbody = document.querySelector('#receiptsTable tbody');
  tbody.innerHTML = '';
  
  console.log('Rendering receipts:', receipts.length);
  
  if (receipts.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">No paid invoices found. Mark invoices as paid to generate receipts.</td></tr>';
    document.getElementById('receiptStats').textContent = '';
    return;
  }
  
  const totalAmount = receipts.reduce((sum, receipt) => sum + parseFloat(receipt.amount || 0), 0);
  document.getElementById('receiptStats').textContent = `Showing ${receipts.length} receipts | Total Amount: Ksh ${totalAmount.toLocaleString()}`;
  
  receipts.forEach(receipt => {
    const displayReceiptNumber = receipt.invoice_number || `RCP-${receipt.id}`;
    
    // Fix data access - use correct property paths
    const tenantName = receipt.tenants?.name || receipt.tenant_name || 'N/A';
    const tenantPhone = receipt.tenants?.phone || 'N/A';
    const propertyName = receipt.properties?.name || 'N/A';
    const houseNumber = receipt.house_number || 'N/A';
    const paidDate = receipt.paid_date || receipt.payment_date || 'N/A';
    
    tbody.innerHTML += `<tr>
      <td><strong>${displayReceiptNumber}</strong></td>
      <td>${tenantName}</td>
      <td>${tenantPhone}</td>
      <td>${propertyName}</td>
      <td>${houseNumber}</td>
      <td><strong style="color: var(--green);">Ksh ${Number(receipt.amount).toLocaleString()}</strong></td>
      <td>${paidDate}</td>
      <td class="actions">
        <button class="view" onclick="generateReceiptPDF('${receipt.id}')" title="Download Receipt">üßæ PDF</button>
        <button class="edit" onclick="viewReceipt('${receipt.id}')" title="View Details">üëÅÔ∏è View</button>
      </td>
    </tr>`;
  });
}

function generateReceiptPDF(receiptId) {
  const receipt = allReceipts.find(r => r.id == receiptId);
  if (!receipt) {
    alert('Receipt not found');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Header
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text('RENT POA', 105, 30, { align: 'center' });
  doc.setFontSize(16);
  doc.text('PAYMENT RECEIPT', 105, 45, { align: 'center' });
  
  // Receipt details
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  const receiptNumber = receipt.invoice_number || `RCP-${receipt.id}`;
  const tenantName = receipt.tenants?.name || receipt.tenant_name || 'N/A';
  const propertyName = receipt.properties?.name || 'N/A';
  const houseNumber = receipt.house_number || 'N/A';
  const paidDate = receipt.paid_date || receipt.payment_date || 'N/A';
  
  let yPos = 65;
  doc.text(`Receipt #: ${receiptNumber}`, 20, yPos);
  doc.text(`Date: ${paidDate}`, 120, yPos);
  
  yPos += 15;
  doc.text(`Tenant Name: ${tenantName}`, 20, yPos);
  doc.text(`Phone: ${receipt.tenants?.phone || 'N/A'}`, 20, yPos + 7);
  
  yPos += 25;
  doc.text(`Property: ${propertyName}`, 20, yPos);
  doc.text(`House #: ${houseNumber}`, 20, yPos + 7);
  
  yPos += 25;
  doc.setFont(undefined, 'bold');
  doc.text(`Amount Paid: Ksh ${Number(receipt.amount).toLocaleString()}`, 20, yPos);
  
  yPos += 20;
  doc.setFont(undefined, 'normal');
  doc.text('Payment Details:', 20, yPos);
  doc.text(`Invoice #: ${receipt.invoice_number || 'N/A'}`, 20, yPos + 7);
  doc.text(`Due Date: ${receipt.due_date}`, 20, yPos + 14);
  
  yPos += 30;
  doc.setFontSize(10);
  doc.text('Thank you for your payment!', 105, yPos, { align: 'center' });
  doc.text('Generated by RentPoa Property Management System', 105, yPos + 7, { align: 'center' });
  
  const tenantNameForFile = receipt.tenants?.name || receipt.tenant_name || 'Unknown_Tenant';
  doc.save(`Receipt_${receiptNumber}_${tenantNameForFile.replace(/\s+/g, '_')}.pdf`);
}

function viewReceipt(receiptId) {
  const receipt = allReceipts.find(r => r.id == receiptId);
  if (!receipt) {
    alert('Receipt not found');
    return;
  }
  
  const receiptNumber = receipt.invoice_number || `RCP-${receipt.id}`;
  const tenantName = receipt.tenants?.name || receipt.tenant_name || 'N/A';
  const propertyName = receipt.properties?.name || 'N/A';
  const houseNumber = receipt.house_number || 'N/A';
  const paidDate = receipt.paid_date || receipt.payment_date || 'N/A';
  
  const message = `
RECEIPT DETAILS
===============

Receipt #: ${receiptNumber}
Paid Date: ${paidDate}

TENANT INFORMATION
------------------
Name: ${tenantName}
Phone: ${receipt.tenants?.phone || 'N/A'}
Email: ${receipt.tenants?.email || 'N/A'}

PROPERTY INFORMATION
--------------------
Property: ${propertyName}
House Number: ${houseNumber}

PAYMENT INFORMATION
-------------------
Amount: Ksh ${Number(receipt.amount).toLocaleString()}
Due Date: ${receipt.due_date}
Invoice #: ${receipt.invoice_number || 'N/A'}

Generated by RentPoa Property Management System
  `.trim();
  
  alert(message);
}

async function exportReceiptsData() {
  try {
    showLoading();
    const propertyFilter = document.getElementById('receiptPropertyFilter').value;
    const tenantFilter = document.getElementById('receiptTenantFilter').value;
    
    let filteredReceipts = [...allReceipts];
    
    // Apply the same filtering logic as filterReceipts()
    if (propertyFilter) {
      filteredReceipts = filteredReceipts.filter(receipt => receipt.tenants?.property_id === propertyFilter);
    }
    
    if (tenantFilter) {
      filteredReceipts = filteredReceipts.filter(receipt => receipt.tenants?.id === tenantFilter);
    }
    
    if (filteredReceipts.length === 0) {
      alert('No receipts to export');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(20);
    doc.text('Receipts Report', 14, 20);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 28);
    doc.text(`Total Receipts: ${filteredReceipts.length}`, 14, 35);
    
    const tableData = filteredReceipts.map(receipt => [
      receipt.invoice_number || `RCP-${receipt.id}`,
      receipt.tenants?.name || receipt.tenant_name || 'N/A',
      receipt.tenants?.phone || 'N/A',
      receipt.properties?.name || 'N/A',
      receipt.house_number || 'N/A',
      `Ksh ${Number(receipt.amount).toLocaleString()}`,
      receipt.paid_date || 'N/A'
    ]);
    
    doc.autoTable({
      startY: 42,
      head: [['Receipt #', 'Tenant', 'Phone', 'Property', 'House', 'Amount', 'Paid Date']],
      body: tableData,
      theme: 'striped',
      headStyles: { fillColor: [11, 11, 11] },
      styles: { fontSize: 8 }
    });
    
    const totalAmount = filteredReceipts.reduce((sum, receipt) => sum + parseFloat(receipt.amount || 0), 0);
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(12);
    doc.text(`Total Amount: Ksh ${totalAmount.toLocaleString()}`, 14, finalY);
    doc.save(`Receipts_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    alert('Receipts report exported successfully!');
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    hideLoading();
  }
}

// Function to check if user can access dashboard
async function canUserAccessDashboard() {
  if (!userSubscription) return false;
  
  // Owner can always access
  if (userSubscription.subscription_type === 'owner') return true;
  
  // Paid subscriptions can access
  if (userSubscription.subscription_status === 'active' && userSubscription.payment_verified) return true;
  
  // Trial users can access if trial hasn't expired
  if (userSubscription.subscription_type === 'trial' && userSubscription.subscription_status === 'trial') {
    const now = new Date();
    const trialExpires = new Date(userSubscription.trial_expires_at);
    return trialExpires > now;
  }
  
  // Expired trials cannot access
  if (userSubscription.subscription_status === 'expired') return false;
  
  return false;
}

// Modified authentication state change handler
supabase.auth.onAuthStateChange(async (event, session) => {
  console.log('Auth state changed:', event, session);
  
  if (event === 'SIGNED_IN' && session) {
    currentUser = session.user;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('signupScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    
    const userName = session.user.user_metadata?.name || session.user.email;
    document.getElementById('userName').textContent = userName;
    
    // Check for owner email first - grant owner access if email matches
    const ownerEmails = [
      'admin@rentpoa.com',
      'owner@rentpoa.com', 
      'charlessoftware2025@gmail.com',
      'daisy@rentpoa.com',
      'charlesogutu081@gmail.com'
    ];
    
    if (ownerEmails.includes(session.user.email.toLowerCase())) {
      console.log('üèÜ OWNER ACCESS GRANTED for email:', session.user.email);
      userSubscription = {
        subscription_status: 'active',
        subscription_type: 'owner',
        subscription_expires_at: new Date(2030, 0, 1).toISOString(),
        payment_verified: true
      };
      updateSubscriptionUI();
    } else {
      await checkSubscription();
    }
    
    // Check if user can access dashboard
    const canAccess = await canUserAccessDashboard();
    
    if (canAccess) {
      // User can access dashboard
      loadDashboard();
    } else {
      // User cannot access - show payment modal and hide dashboard
      console.log('‚õî Access denied - showing payment modal');
      showPaymentModal();
      
      // Hide main content and show payment modal
      document.querySelector('.content').style.display = 'none';
      document.getElementById('trialBanner').style.display = 'none';
    }
    
  } else if (event === 'SIGNED_OUT' || !session) {
    currentUser = null;
    if (trialCheckInterval) clearInterval(trialCheckInterval);
    document.getElementById('app').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('signupScreen').style.display = 'none';
  }
});

// ========== TESTING HELPERS ==========

// Helper function to test trial expiration (for testing only)
function testTrialExpiration() {
  if (confirm('This will set your trial to expired for testing. Continue?')) {
    supabase
      .from('subscriptions')
      .update({ 
        subscription_status: 'expired',
        updated_at: new Date().toISOString()
      })
      .eq('user_id', currentUser.id)
      .then(() => {
        alert('Trial set to expired. Try refreshing the page.');
        location.reload();
      });
  }
}

// Helper function to check current subscription status
function checkCurrentStatus() {
  console.log('üîç Current subscription status:', userSubscription);
  console.log('üîç Current user:', currentUser);
  
  if (userSubscription?.trial_expires_at) {
    const expiresAt = new Date(userSubscription.trial_expires_at);
    const now = new Date();
    const timeLeft = expiresAt - now;
    
    if (timeLeft > 0) {
      const minutes = Math.floor(timeLeft / 60000);
      const seconds = Math.floor((timeLeft % 60000) / 1000);
      console.log(`‚è∞ Time remaining: ${minutes}m ${seconds}s`);
    } else {
      console.log('‚è∞ Trial has expired');
    }
  }
}

console.log('üí° Testing helpers available:');
console.log('- testTrialExpiration() - Set trial to expired for testing');
console.log('- checkCurrentStatus() - Check current subscription status');
</script>
</body>
</html>